// crud version 0.4.0
// (MIT) 16-02-2014
// https://github.com/DubFriend/CRUD
(function(){"use strict";var a=function(a){return a},b=function(a,b){return b[a]},c=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}},d=function(a){return $.isArray(a)},e=function(a){return!d(a)&&null!==a&&"object"==typeof a},f=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},g=function(a){return!isNaN(a)},h=function(a){return g(a)&&Number(a)%1===0},i=function(a){return $.extend(!0,{},a)},j=function(b){return r(b,a)},k=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},l=function(a,b){var c,d,e,f=[];for(void 0===b?(d=0,e=a-1):(d=a,e=b),c=d;e>=c;c+=1)f.push(c);return f},m=function(a){var b,c=[];for(b=a.length-1;b>=0;b-=1)c.push(a[b]);return c},n=function(a){return a[a.length-1]},o=function(a,b){var c=[];return k(a,function(a,d,e){c.push(b(a,d,e))}),c},p=function(a,b,c){var d={};return k(a,function(a,e,f){e=c?c(e,a):e,d[e]=b(a,e,f)}),d},q=function(b,c){return r(c,a,function(a){return b+a})},r=function(a,b,c){return d(a)?o(a,b):p(a,b,c)},s=function(a,b){var c;return k(a,function(d,e){c=b(c,d,e,a)}),c},t=function(a,b){var c;return d(a)?(c=[],k(a,function(a,d,e){b(a,d,e)&&c.push(a)})):(c={},k(a,function(a,d,e){b(a,d,e)&&(c[d]=a)})),c},u=function(){var a,b,c={};for(a=0;a<arguments.length;a+=1)b=arguments[a],k(b,function(a,b){c[b]=a});return c},v=function(a,b){return t(a,function(a,c){return-1!==b.indexOf(c)})},w=function(a,b){return t(a,function(a){return a!==b})},x=function(a,b){var c=null;return function(){var d=this,e=arguments;null===c&&(c=setTimeout(function(){c=null},a),b.apply(d,e))}},y=function(a,b,c){var d=null,e=!1;return function(){var f=this,g=arguments;null===d?(d=setTimeout(function(){(!c||e)&&b.apply(f,g),e=!1,d=null},a),c&&b.apply(f,g)):e=!0}},z=function(){var a=0;return function(){return a+=1}}(),A=function(a){a=a||{};var b={};return a.publish=function(a,c){k(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){k(b,function(b){var c=$.inArray(a,b);-1!==c&&b.splice(c,1)})},a},B=function(){var a={},b=u,c=function(a){var b,c,d,e="",f="",g=function(){var b=-1!==a.indexOf("#"),c=-1!==a.indexOf("?"),d="";return c&&(d=a.split("?")[1]||"",b&&(d=d.split("#")[0]||"")),e=c?a.split("?")[0]||"":b?a.split("#")[0]||"":a,b&&(f=a.split("#")[1]||""),d?d.split("&"):[]},h=g(a),i={};for(d=0;d<h.length;d+=1)b=h[d].split("=")[0],c=h[d].split("=")[1],i[b]=c;return{url:e||"",hash:f||"",parameters:i}},d=function(a){var b=[];return k(a.parameters,function(c,d){b.push(d+"="+a.parameters[d])}),a.url+(b.length>0?"?"+b.join("&"):"")+(a.hash?"#"+a.hash:"")};return a.get=function(a){return c(a).parameters},a.set=function(a,e){var f=c(a);return f.parameters=b(f.parameters,e),d(f)},a}();"undefined"==typeof console&&(console={},console.warn=function(){});var C=function(a,b){a=a||{};var c=A();return b.url=a.url,b.data=a.data,c.validate=a.validate||function(){return{}},c.get=function(a){return a?b.data[a]:i(b.data)},c.set=function(a,d,e){e=e||{};var g=e.validate===!1?{}:c.validate(d);return f(g)?(b.data=u(b.data,d),e.silent!==!0&&(c.publish("change",d),a(d,e)),!0):(e.silent!==!0&&c.publish("error",g),!1)},c},D=function(a,b){409===b.status&&a.publish("error",b.responseJSON)},E=function(a){a=a||{};var b={},d=C(a,b),e=a.id,g=(a.deletable,a.isSoftREST),h=a.ajax||function(a){var e,f,h=d.isNew()?b.url:B.set(b.url,{id:d.id()});g?(h=B.set(h,{method:a.method}),e="POST",f=b.data):(e=a.method,f="PUT"===a.method||"DELETE"===a.method?JSON.stringify(b.data):b.data),$.ajax({url:h,method:e,data:f,cache:!1,dataType:a.dataType||"json",beforeSend:c(d.publish,"form:waiting:start"),success:a.success,error:a.error||c(D,d),complete:a.complete||c(d.publish,"form:waiting:end")})};return d.isNew=function(){return void 0===e?!0:!1},d.id=function(){return e},d.set=c(d.set,function(){}),d.clear=function(){b.data={},e=void 0,d.publish("change",d)},d.save=function(){var a=d.validate(d.get());f(a)?h({url:d.isNew()?b.url:B.set(b.url,{id:e}),method:d.isNew()?"POST":"PUT",data:b.data,success:function(a){var b=d.isNew();e=d.isNew()?a:e,d.publish("saved",b)},error:function(a,b){console.log("error: ",b),D(d,a)}}):d.publish("error",a)},d["delete"]=function(){d.isNew()?(d.publish("destroyed"),d.clear()):h({url:B.set(b.url,{id:e}),method:"DELETE",success:function(){var a=d.id();d.publish("destroyed",a)}})},d},F=function(){var a,b,d,e,f=A(),g=function(b){b=b||{},$.ajax({url:B.set(a,{page:b.page||1}),cache:!1,method:"GET",data:u(e?q("filter_",e.get()):{},q("order_",d.get())),dataType:"json",beforeSend:c(f.publish,b.moduleName+":waiting:start"),success:function(a){c(f.publish,"load")(a)},error:c(D,f),complete:c(f.publish,b.moduleName+":waiting:end")})};return f.init=function(c){a=c.url,b=c.paginatorModel,e=c.filterModel,d=c.orderModel},f.changePage=function(a,b){g({page:a,moduleName:b})},f.search=function(a){1!==b.get("pageNumber")&&b.set({pageNumber:1}),g({moduleName:a})},f},G=function(a){a=a||{};var b={},d=C(a,b),e=a.requestModel;return d.set=c(d.set,c(e.search,"filter")),d},H=function(a){a=a||{};var b={},d=C(a,b),e=i(a.data),f=a.requestModel;return d.set=c(d.set,c(f.search,"order")),d.toggle=function(){var a=["neutral","ascending","descending"];return function(c){var f=$.inArray(b.data[c],a),g=(f+1)%a.length,h={};h[c]=a[g],"neutral"!==h[c]?d.set(u(r(e,function(){return"neutral"}),h)):d.set(h)}}(),d},I=function(a){a=a||{},a.data=a.data||{},a.data.pageNumber=a.pageNumber||1,a.data.numberOfPages=a.numberOfPages||1;var b={},d=C(a,b),e=a.requestModel;return d.validate=function(a){a=a||b.data;var c={},d=void 0!==a.numberOfPages?a.numberOfPages:b.data.numberOfPages,e=void 0!==a.pageNumber?a.pageNumber:b.data.pageNumber;return 0>=e?c.pageNumber="Page number must be greater than zero.":e>d&&(c.pageNumber="Page number must be less than or equal to the number of pages."),c},d.set=c(d.set,function(a){a.pageNumber&&(d.publish("change:pageNumber",a),e.changePage(a.pageNumber,"paginator"))}),d},J=function(a){a=a||{};var b={},d=C(a,b);return d.set=c(d.set,function(){}),d.submit=function(a){var c=d.validate(d.get());f(c)&&$.ajax({url:b.url,method:a.method||"POST",data:b.data,dataType:"json",beforeSend:function(){d.publish("waiting:start"),a.beforeSend()},success:function(b){d.publish("posted",b),a.success(b)},error:function(b){D(d,b),a.error(b)},complete:function(b){d.publish("waiting:end",b),a.complete(b)}}),d.publish("error",c)},d},K=function(a){var b=a.item,c=b.name,d=a.name,e=a["class"]||"",f=a.ID?a.ID+"-":z()+"-",g=function(a,g){var h=function(){return"checkbox"===b.type||"radio"===b.type?'value="'+g+'" ':'value="{{'+c+'}}" '},i=function(){return"checkbox"===b.type||"radio"===b.type?'id="'+f+c+"-"+g+'" ':'id="'+f+d+"-"+c+'" '};return'<input type="'+b.type+'" '+i()+'name="'+c+'" '+h()+' class="'+e+'" '+(a?"checked":"")+"/>"},h=function(){return""+s(b.values,function(a,b){var d=b.value;return(a||"")+'<label for="'+f+c+"-"+d+'">'+(b.label||d)+"</label>{{#"+c+"."+d+"}}"+g(!0,d)+"{{/"+c+"."+d+"}}{{^"+c+"."+d+"}}"+g(!1,d)+"{{/"+c+"."+d+"}}"})};switch(b.type){case"text":return g();case"password":return g();case"textarea":return'<textarea id="'+f+d+"-"+c+'" name="'+c+'" class="'+e+'">{{'+c+"}}</textarea>";case"checkbox":return h();case"radio":return h();case"select":return'<select name="'+c+'" class="'+e+'">'+s(b.values,function(a,b){var d=b.value;return a=a||"",a+"{{#"+c+"."+d+'}}<option value="'+d+'" selected>'+(b.label||d)+"</option>{{/"+c+"."+d+"}}{{^"+c+"."+d+'}}<option value="'+d+'">'+(b.label||d)+"</option>{{/"+c+"."+d+"}}"})+"</select>";default:throw"Invalid input type: "+b.type}},L=function(a,b){return s(a,function(a,c){return(a||"")+'<div class="crud-control-set"><label for="'+b+"-"+c.name+'">'+(c.label||c.name)+'</label><div class="crud-input-group">'+K({item:c,name:b,"class":"foo"})+'</div><div class="crud-help">{{'+c.name+"Help}}</div></div>"})},M=function(){return'<div class="crud-delete-modal modal"><div class="crud-modal-dialogue"><p class="crud-message">Are you sure you want to delete the selected items?</p><center><button class="crud-confirm-delete">Delete</button><button class="crud-cancel-delete">Cancel</button></center></div></div>'},N=function(a,b,c,d){return"<form><fieldset><legend>Search "+d+"</legend>"+L(a,b)+'<div class="crud-control-set"><div class="label">&nbsp;</div>'+(c?"":'<div class="crud-input-group"><input type="submit" value="Search"/></div>')+"</div></fieldset></form>"},O=function(a,b,c){return"<form><fieldset><legend>"+c+'</legend><span class="crud-status">{{status}}</span>'+L(a,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group"><input type="submit" value="Save"/><button class="crud-close-form">Close</button></div><div class="crud-help">{{GLOBALHelp}}</div></div></fieldset></form>'},P=function(a,b,c,d,e){return""+M()+"<form><fieldset><legend>"+e+'</legend><span class="crud-status">{{status}}</span>'+L(a,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group">'+(d?"":'<input type="submit" value="Save"/>')+(c?'<button class="crud-delete">Delete</button>':"")+'</div><div class="success">{{successMessage}}</div><div class="crud-help">{{GLOBALHelp}}</div></div></fieldset></form>'},Q=function(a){return"{{#orderable."+a+'}}<a href="#" data-name="'+a+'" class="crud-order">{{#order.'+a+".ascending}}{{{orderIcon.ascending}}}{{/order."+a+".ascending}}{{#order."+a+".descending}}{{{orderIcon.descending}}}{{/order."+a+".descending}}{{#order."+a+".neutral}}{{{orderIcon.neutral}}}{{/order."+a+".neutral}}</a>{{/orderable."+a+"}}"},R=function(a,b,c,d,e){var f=z();return"<table><thead><tr>"+(e?"":"<th>"+(d?'<label for="'+f+'-crud-list-select-all">All</label><input type="checkbox" id="'+f+'-crud-list-select-all" class="crud-list-select-all"/>':"")+"</th>")+(c?"<th>"+Q("id")+'<span class="crud-th-content">'+(c.label||"id")+"</span></th>":"")+s(a,function(a,b){return(a||"")+"<th>"+Q(b.name)+'<span class="crud-th-content">'+(b.label||b.name)+"</span></th>"})+'</tr></thead><tbody class="crud-list-item-container"></tbody></table>'+(d?'<button class="crud-delete-selected">Delete Selected</button>':"")},S=function(a,b,c,d){return""+(d?"":"<td>"+(c?'<input type="checkbox" class="crud-list-selected"/>':"")+(d?"":'<input type="button" class="crud-edit-button" value="Edit"/>')+"</td>")+(b?'<td name="id">{{id}}</td>':"")+s(a,function(a,b){return(a||"")+'<td name="'+b.name+'">{{'+b.name+"}}</td>"})},T=function(){return'<div class="crud-paginator"><ol class="crud-pages">{{#pages}}<li><a data-page-number="{{.}}" href="#">{{.}}</a></li>{{/pages}}</ol><form class="crud-goto-page-form"><span class="number-of-pages">pages: {{numberOfPages}}</span><input type="text" name="goto-page" placeholder="page #"/><input type="submit" value="Go"/><div class="crud-help"></div></form></div>'},U=function(a,b){return"<form><fieldset><legend>"+b+"</legend>"+L(a.form,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group">'+s(a.actions,function(a,b){return(a||"")+'<input type="'+b.type+'" class="'+b["class"]+'" value="'+b.label+'"/>'})+'</div><div class="success">{{successMessage}}</div></div></fieldset></form>'},V=function(a,b){return r(b,function(b,c){var d=function(b){return a.find('[name="'+c+'"]'+(b||"")).val()};switch(b.type){case"radio":return d(":checked");case"select":return d(" option:selected");case"checkbox":var e=[];return a.find('[name="'+c+'"]:checked').each(function(){e.push($(this).val())}),e;default:return d()}})},W=function(b){var f=A(),g=b.el,h=function(a,c,d,e){c=c||f.model.get(),d=a?f.mapErrorData(u(f.model.validate(c),d)):{},f.$().html(b.render(f.template,u(f.mapModelToView(c),d,e||{})))};return f.setEl=function(a){g=a},f.mapErrorData=function(b){return r(b,a,function(a){return a+"Help"})},f.mapSchema=function(a){return p(a,function(a){return t(a,function(a,b){return"name"!==b})},function(a,b){return b.name})},f.schema=f.mapSchema(b.schema),f.model=b.model,f.template=b.template,f.$=function(a){return a?$(g).find(a):$(g)},f.mapModelToView=function(a,b){b=b||f.schema;var c=function(a,c,e){b[e].type;return d(c)?-1!==$.inArray(a,c):a===c};return r(a,function(a,d){if(b[d]){var f=b[d].type;if("checkbox"===f||"select"===f||"radio"===f){var g={};return k(b[d].values,function(b){var f=e(b)?b.value:b;c(f,a,d)&&(g[f]=!0)}),g}return a}console.warn("warning: schema attribute of name: "+d+" does not exist.")})},f.render=c(h,!0),f.renderNoError=c(h,!1),f},X=function(a){a=a||{};var b=W(a),d=b.mapSchema(a.filterSchema),e=a.isInstantFilter,f=function(){return V(b.$(),d)},g=b.mapModelToView,h=c(y,500,function(){b.model.set(f())});return b.mapModelToView=function(a){return g(a,d)},b.renderNoError(),e&&k(d,function(a,c){var d=b.$('[name="'+c+'"]');switch(a.type){case"text":case"password":case"textarea":d.keyup(h(!1));break;case"radio":case"checkbox":case"select":d.change(h(!0));break;default:throw"Invalid item type: "+a.type}}),b.$().submit(function(a){a.preventDefault(),b.model.set(f())}),b},Y=function(a,b){a=a||{},b=b||{},a.model=a.model||a.createDefaultModel();var c=W(a),d=a.modal;c.serialize=function(){return V(c.$(),c.schema)},c.open=function(){d.open(c.$())},c.close=function(){d.close(c.$())},c.save=function(){c.model.set(c.serialize(),{validate:!1}),c.model.save()},b.bind=function(){c.$().unbind(),c.$().submit(function(a){a.preventDefault(),c.save()}),c.$(".crud-close-form").unbind(),c.$(".crud-close-form").click(function(a){a.preventDefault(),c.close()}),c.publish("bind")},b.bind();var e=function(){c.model.isNew()?(c.$("*").removeClass("crud-status-edit"),c.$("*").addClass("crud-status-create")):(c.$("*").addClass("crud-status-edit"),c.$("*").removeClass("crud-status-create"))},f=c.render;c.render=function(a,d,g){f(a,d,u({status:c.model.isNew()?"Create":"Edit"},g)),e(),b.bind()};var g=c.renderNoError;return c.renderNoError=function(a){g(a,void 0,{status:c.model.isNew()?"Create":"Edit"}),c.$(".crud-new-item").hide(),e(),b.bind()},c.setModel=function(){var a=function(){e(),c.close()},b=function(){c.render()},d=function(a){c.render(c.model.get(),a)};return function(e){c.model.unsubscribe(b),c.model.unsubscribe(a),c.model.unsubscribe(d),e.subscribe("change",b),e.subscribe("saved",a),e.subscribe("error",d),c.model=e,e.isNew()?c.renderNoError():c.render()}}(),c},Z=function(a){var b={},c=Y(a,b),d=a.modal,e=(a.deleteConfirmationTemplate,a.isDisplaySavedMessage),f=function(){d.open(c.$(".crud-delete-modal"))},g=function(){d.close(c.$(".crud-delete-modal"))};e&&c.model.subscribe("saved",function(){c.render(c.model.get(),{},{successMessage:"Save Successfull."}),setTimeout(function(){c.$(".success").html("")},5e3)}),c.setModel(c.model);var h=b.bind;return b.bind=function(){c.$(".crud-delete").unbind(),c.$(".crud-delete").click(function(a){a.preventDefault(),f()}),c.$(".crud-confirm-delete").unbind(),c.$(".crud-confirm-delete").click(function(a){a.preventDefault(),c.model["delete"](),g()}),c.$(".crud-cancel-delete").unbind(),c.$(".crud-cancel-delete").click(function(a){a.preventDefault(),g()}),h()},c},_=function(a){a=a||{};var d=W(a),e=$("#"+a.name+"-crud-confirm-delete"),f=[],g=a.isIDOrderable===!0?!0:!1,h={ascending:"&#8679;",descending:"&#8681;",neutral:"&#8691;"},i=a.modal,j=a.deleteConfirmationTemplate,l=function(){i.open(e.find(".crud-delete-modal"))},m=function(){i.close(e.find(".crud-delete-modal"))},n=function(){e.find(".crud-cancel-delete").unbind(),e.find(".crud-confirm-delete").unbind(),e.find(".crud-cancel-delete").click(m),e.find(".crud-confirm-delete").click(function(){k(f,function(a){a.isSelected()&&a.model["delete"]()}),m()})},o=function(){d.$(".crud-list-select-all").unbind(),d.$(".crud-list-select-all").change(function(){d.$(".crud-list-selected").prop("checked",$(this).is(":checked"))}),d.$(".crud-delete-selected").unbind(),d.$(".crud-delete-selected").click(l),d.$(".crud-list-selected").unbind(),d.$(".crud-list-selected").change(function(){d.$(".crud-list-select-all").prop("checked",!1)}),d.$(".crud-order").unbind(),d.$(".crud-order").click(function(a){a.preventDefault(),d.orderModel.toggle($(this).data("name"))}),d.publish("bind")};e.html(a.render(j)),n(),d.orderModel=a.orderModel;d.renderNoError;return d.renderNoError=function(){var e={orderable:u({id:g},r(d.schema,c(b,"orderable"))),order:u(r(d.orderModel.get(),function(a){return"ascending"===a?{ascending:!0}:"descending"===a?{descending:!0}:{neutral:!0}})),orderIcon:h};d.$().html(a.render(d.template,e))},d.renderItems=function(){var a=d.$(".crud-list-item-container");a.html(""),k(f,function(b){var c="crud-list-item-"+b.model.id();a.append('<tr id="'+c+'"></tr>'),b.render()}),o()},d.setSelected=function(a){k(f,function(a){a.deselect()}),a&&a.select(),d.selectedItem=a},d.setNextSelected=function(){var a=f.indexOf(d.selectedItem||f[0]);if(-1!==a&&a+1<f.length){var b=f[a+1];b.publish("selected",b)}},d.setPreviousSelected=function(){var a=f.indexOf(d.selectedItem||f[1]);if(a>0){var b=f[a-1];b.publish("selected",b)}},d.setSelectAll=function(a){d.$(".crud-list-select-all").prop("checked",a)},d.add=function(a,b){b=b||{},b.prepend===!0?f.unshift(a):f.push(a)},d.getItemControllerByID=function(a){return t(f,function(b){return b.model.id()===a})[0]},d.clear=function(){f=[]},d.remove=function(a){f=t(f,function(b){return b.model.id()!=a})},d.orderModel.subscribe("change",function(a){k(a,function(a,b){d.$('[data-name="'+b+'"]').html("<span  crud-order-"+a+'">'+h[a]+"</span>")})}),d},ab=function(a){a=a||{},a.el="#"+a.name+"-crud-list-container #crud-list-item-"+a.model.id();var b=W(a);b.isSelected=function(){return b.$(".crud-list-selected").prop("checked")?!0:!1};var c=function(a,c){{var d;b.schema[a]}return k(b.schema[a].values,function(a){a.value===c&&(d=a.label||a.value)}),d},d=b.mapModelToView;b.mapModelToView=function(a){return u({id:b.model.id()},r(d(a),function(a,b){return e(a)?o(a,function(a,d){return c(b,d)}).join(", "):a}))};var f=b.render;return b.render=function(a){f(a),b.bindView()},b.select=function(){b.$().addClass("selected")},b.deselect=function(){b.$().removeClass("selected")},b.bindView=function(){b.$().hover(function(){b.$().addClass("hover")},function(){b.$().removeClass("hover")}),b.$().click(function(){b.publish("selected",b)}),b.$().dblclick(function(){b.publish("edit",b)}),b.$(".crud-edit-button").click(function(){b.publish("edit",b)}),b.publish("bind")},b.model.subscribe("saved",function(){b.render()}),b},bb=function(a){a=a||{};var b=W(a),c=function(){b.$("li a").unbind(),b.$("li a").click(function(a){a.preventDefault();var c=Number($(this).data("page-number"));b.model.set({pageNumber:c})}),b.$(".crud-goto-page-form").unbind(),b.$(".crud-goto-page-form").submit(function(a){a.preventDefault();var c=b.$(".crud-goto-page-form").find('[name="goto-page"]'),d=c.val();h(d)?b.model.set({pageNumber:Number(d)}):c.val("")}),b.publish("bind")},d=function(){var a=function(a){var b=[];return k(m(a),function(a){0>=a?b.push(n(b)+1):b.unshift(a)}),b},c=function(a){var c=[];return k(a,function(a){var d=0===c.length?a:c[0]-1;a<=b.model.get("numberOfPages")?c.push(a):d>0&&c.unshift(d)}),c},d=b.model.get("pageNumber");return c(a(l(d-3,d+3)))};return b.setSelected=function(a){b.$("li a").removeClass("selected"),b.$('li a[data-page-number="'+a+'"]').addClass("selected")},b.render=function(e){var f=b.model.get("numberOfPages");if(f>1){e=e||d();var g=b.model.validate();b.$().html(a.render(b.template,{pages:e,numberOfPages:f,error:g})),b.setSelected(b.model.get("pageNumber")),c()}else b.$().html("")},b.setPage=function(a){b.model.set({pageNumber:a})},b.setNextPage=x(300,function(){var a=b.model.get("pageNumber");a+1<=b.model.get("numberOfPages")&&b.setPage(a+1)}),b.setPreviousPage=x(300,function(){var a=b.model.get("pageNumber");a>1&&b.setPage(a-1)}),b.model.subscribe("change",function(){b.render()}),b},cb=function(a){a=a||{};var b=W(a),e=a.actions;b.serialize=function(){return V(b.$(),b.schema)},b.clear=function(){b.model.set(r(b.model.get(),function(a){return d(a)?[]:""}),{validate:!1,silent:!0}),b.renderNoError()};var f=function(){var a={$:b.$,render:b.render,renderNoError:b.renderNoError,set:b.model.set,get:b.model.get,clear:b.clear},d=function(b,c){return b[c]?function(){b[c].apply(a)}:function(){}};k(e,function(e){var f=c(d,e);if(b.$().submit(function(a){a.preventDefault()}),"submit"===e.type)b.$().unbind(),b.$().submit(function(a){a.preventDefault(),b.model.set(b.serialize(),{validate:!1}),b.model.submit({method:e.method,beforeSend:f("beforeSend"),success:f("success"),error:f("error"),complete:f("complete")})});else{if("button"!==e.type)throw"Unexpected action type "+e.type;b.$('[value="'+e.label+'"]').unbind(),b.$('[value="'+e.label+'"]').click(function(){e.action.apply(a)})}}),b.publish("bind")};f();var g=b.render;b.render=function(a,b,c){g(a,b,c),f()};var h=b.renderNoError;return b.renderNoError=function(a,b){h(a,{},b),f()},b.model.subscribe("change",b.render),b.model.subscribe("error",function(a){b.render(b.model.get(),a)}),b.renderNoError(),b};this.CRUD=function(){var d=function(a,b){return b?!1:a===!1?!1:!0},e=function(a){return"checkbox"===a.type&&(a.value=a.value||[]),a},g=function(a){return r(a,function(a){var d=i(a);switch(d.type){case"radio":case"checkbox":case"select":d.values=r(d.values,c(b,"value"))}return d})},h=function(a){return p(a,function(a){return a.value||null},function(a,b){return b.name})},l=function(a,b,c){return E({id:c,url:a.url,isSoftREST:a.isSoftREST,data:b||h(a.schema),validate:a.validate})},m=function(a,b,d){return c(a,"bind:"+d,b.$)},n=function(a,b,d){b.subscribe(d+":waiting:start",c(a,d+":waiting:start")),b.subscribe(d+":waiting:end",c(a,d+":waiting:end"))},o={open:function(a){a.modal({fadeDuration:200,fadeDelay:0,showClose:!1})},close:function(){$.modal.close()}};return{full:function(f){f=f||{};var h,i,j,q=A(),s=f.url,v=f.name,w=f.label||v,x=f.id||!1,y=f.instantFilter||!1,B=f.readOnly||!1,C=d(f.deletable,B),D=f.render||function(a,b){return Mustache.render(a,b)},E=f.isSoftREST||!1,J=f.modal||o,L=r(f.schema,e),P=r(f.filterSchema,e),U=g(L),V=g(P),W=f.validate,Z=c(l,{url:s,isSoftREST:E,schema:U,validate:W}),cb=function(a){sb.setSelected(a),B||ib(a.model)},db=function(a){cb(a),ub.open()},eb=function(a,b){b=b||{};var c=ab({name:v,model:a,schema:L,template:lb,render:D});return c.subscribe("selected",cb),c.subscribe("edit",db),sb.add(c,b),sb.setSelected(c),b.bind!==!1&&hb(a),c},fb=function(a){sb.clear(),a.length>0?($("#"+v+"-crud-list-container").show(),$("#"+v+"-crud-no-results-message").hide(),k(a,function(a){var b=a.id;delete a.id,eb(Z(a,b)),sb.setSelected()}),sb.renderItems()):($("#"+v+"-crud-list-container").hide(),$("#"+v+"-crud-no-results-message").show())},gb=function(){var a=!0;return function(b){fb(b.data),rb.model.set({numberOfPages:b.pages||1}),a&&(rb.render(),a=!1)}}(),hb=function(a){return a.subscribe("saved",function(b){if(b){var c=eb(a,{prepend:!0,bind:!1});sb.renderItems(),sb.setSelected(c)}}),a.subscribe("destroyed",function(a){sb.remove(a),sb.setSelectAll(!1),sb.renderItems(),jb()}),n(q.publish,a,"form"),a},ib=function(a){ub.setModel(a)},jb=function(){var a=Z();B||ib(a),hb(a)},kb=f.createListTemplate?f.createListTemplate.apply({schema:U,name:v,id:x,deletable:C,readOnly:B,orderable:Q,uniqueID:z}):R(L,v,x,C,B),lb=f.createListItemTemplate?f.createListItemTemplate.apply({schema:L,id:x,deletable:C,readOnly:B}):S(L,x,C,B),mb=f.createPaginatorTemplate?f.createPaginatorTemplate():T(),nb=f.createDeleteConfirmationTemplate?f.createDeleteConfirmationTemplate():M(),ob=F(),pb=I({requestModel:ob}),qb=H({data:r(u({id:x},t(p(U,a,function(a,b){return b.name}),c(b,"orderable"))),function(a){return a.order||"neutral"}),requestModel:ob}),rb=bb({el:"#"+v+"-crud-paginator-nav",model:pb,template:mb,render:D}),sb=_({el:"#"+v+"-crud-list-container",name:v,schema:U,modal:J,isIDOrderable:x&&x.orderable?!0:!1,model:Z(),orderModel:qb,createModel:Z,template:kb,deleteConfirmationTemplate:nb,render:D});f.filterSchema&&(h=f.createFilterTemplate?f.createFilterTemplate.apply({filterSchema:P,name:v,label:w,createInput:K,isInstantFilter:y,uniqueID:z}):N(P,v,y,w),i=G({requestModel:ob,data:p(V,function(a){return"checkbox"===a.type&&(a.value=a.value||[]),void 0===a.value?null:a.value},function(a,b){return b.name})}),j=X({el:"#"+v+"-crud-filter-container",model:i,filterSchema:P,isInstantFilter:y,template:h,render:D}),i.subscribe("change",jb),j.subscribe("bind",m(q.publish,j,"filter")));var tb,ub;return B?ub={open:function(){},close:function(){}}:($("#"+v+"-crud-new").html(f.newButtonHTML||"<button>Create New "+w+"</button>"),$("#"+v+"-crud-new").find("button").click(function(){jb(),ub.publish("new"),ub.open()}),tb=f.createFormTemplate?f.createFormTemplate.apply({schema:L,name:v,label:w,createInput:K,uniqueID:z}):O(L,v,w),ub=Y({el:"#"+v+"-crud-container",schema:U,modal:J,createDefaultModel:function(){return hb(Z())},template:tb,render:D}),ub.subscribe("new",function(){sb.setSelected()}),ub.subscribe("bind",m(q.publish,ub,"form")),pb.subscribe("change",jb)),ob.init({url:s,paginatorModel:pb,filterModel:i,orderModel:qb}),sb.renderNoError(),sb.subscribe("bind",m(q.publish,sb,"list")),rb.subscribe("bind",m(q.publish,rb,"paginator")),ob.subscribe("load",gb),n(q.publish,ob,"filter"),n(q.publish,ob,"order"),n(q.publish,ob,"paginator"),rb.setPage(1),q},formList:function(a){a=a||{};var b,h=A(),i=a.url,p=a.name,q=a.label||p,s=a.readOnly||!1,t=d(a.deletable,s),u=a.saveAll||!1,v=a.isSoftREST||!1,x=a.render||function(a,b){return Mustache.render(a,b)},y=r(a.schema,e),B=g(y),C=a.validate,D=c(l,{url:i,schema:B,isSoftREST:v,validate:C}),F=a.modal||o,G=a.addItemAction||function(a,b){a.hide(),a.slideDown(300,b)},H=a.removeItemAction||function(a,b){a.slideUp(300,b)},I=a.createDeleteConfirmationTemplate||I,J=function(){return a.createFormListTemplate?a.createFormListTemplate.apply({schema:y,name:p,label:q,createInput:K,uniqueID:z,deletable:t,saveAll:u,createDeleteConfirmationTemplate:I}):P(y,p,t,u,q)},L=function(){return a.createFormTemplate?a.createFormTemplate.apply({schema:y,name:p,label:q,createInput:K,uniqueID:z}):O(y,p,q)},M=function(){var a=Y({el:"#"+p+"-crud-container",schema:B,modal:F,model:D(),template:L(),render:x});return a.renderNoError(),a.setModel(a.model),a.model.subscribe("saved",function(b){b&&(R(a.model),a.close())}),a},N=function(){b||(b=M(),b.subscribe("bind",m(h.publish,b.model,"form")),n(h.publish,b.model,"form"),b.model.subscribe("saved",function(){b=null})),b.open()},Q=[],R=function(a){$("#"+p+"-crud-save-all").show();var b=p+"-crud-item-"+z();$("#"+p+"-crud-form-list").prepend('<div class="crud-form-list-item" id="'+b+'"></div>');var c=Z({el:"#"+b,isDisplaySavedMessage:!u,schema:B,modal:F,model:a,template:J(),render:x});c.subscribe("bind",m(h.publish,a,"form")),n(h.publish,a,"form"),c.setEl("#"+b),c.render(),Q.push(c),a.subscribe("destroyed",function(){H(c.$(),function(){Q=w(Q,c),c.$().remove()})}),G(c.$())};return h.saveAllItems=function(){var a=!1,b=j(Q);f(Q)?(h.publish("saveAll:start"),h.publish("saveAll:end")):(k(b,function(c){var d=function(f){a=!0,b=w(b,c),c.model.unsubscribe(d),c.model.unsubscribe(e),h.publish("error",f)},e=function(){b=w(b,c),c.model.unsubscribe(d),c.model.unsubscribe(e),f(b)&&h.publish("saveAll:complete"),f(b)&&!a&&h.publish("saveAll:end")};c.model.subscribe("error",d),c.model.subscribe("saved",e)}),h.publish("saveAll:start"),$("#"+p+"-crud-form-list .crud-form-list-item form").submit())},$("#"+p+"-crud-new").html(a.newButtonHTML||"<button>Create New "+q+"</button>"),$("#"+p+"-crud-new button").click(N),$("#"+p+"-crud-save-all").html(a.saveAllButtonHTML||"<button>Save All</button>"),$("#"+p+"-crud-save-all button").click(h.saveAllItems),$.ajax({method:"GET",url:i,dataType:"json",success:function(a){a.data.length>0?k(a.data,function(a){var b=a.id;delete a.id,R(E({data:a,url:i,validate:C,id:b}))}):$("#"+p+"-crud-save-all").hide()},error:function(){}}),h},forminator:function(a){a=a||{};var b=A(),d=a.url,f=a.name,i=g(r(a.schema,e)),j=a.actions,k={form:r(a.schema,e),actions:r(j,function(a){return v(a,["type","class","label"])})},l=a.validate,m=a.render||function(a,b){return Mustache.render(a,b)},n=J({url:d,data:h(a.schema),validate:l}),o=cb({el:"#"+f+"-forminator",schema:i,actions:j,model:n,template:a.createForminatorTemplate?a.createForminatorTemplate.apply({schema:k,name:f,createInput:K,uniqueID:z}):U(k,f),render:m});return n.subscribe("posted",function(){o.render(n.get(),{},{successMessage:a.successMessage||"Submit Success."})}),n.subscribe("waiting:start",c(b.publish,"waiting:start")),n.subscribe("waiting:end",c(b.publish,"waiting:end")),o.subscribe("bind",c(b.publish,"bind")),b}}}()}).call(this);