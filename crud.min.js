// crud
// https://github.com/DubFriend/CRUD.git
// 11-02-2013
(function(){"use strict";var a=function(a){return a},b=function(a){return a+=1},c=function(a){return a-=1},d=function(a,b){return b[a]},e=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}},f=function(a){return a instanceof Array},g=function(a){return!f(a)&&a instanceof Object},h=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},i=function(a){return JSON.parse(JSON.stringify(a))},j=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},k=function(a){var b,c=[];for(b=a.length-1;b>=0;b-=1)c.push(a[b]);return c},l=function(a){return a[a.length-1]},m=function(a,b){var c=[];return j(a,function(a,d,e){c.push(b(a,d,e))}),c},n=function(a,b,c){var d={};return j(a,function(a,e,f){e=c?c(e):e,d[e]=b(a,e,f)}),d},o=function(b,c){return c=c||{},p(c,a,function(a){return b+a})},p=function(a,b,c){return f(a)?m(a,b):n(a,b,c)},q=function(a){return m(a,function(a,b){return b})},r=function(a){return m(a,function(a){return a})},s=function(a,b){var c;return j(a,function(d,e){c=b(c,d,e,a)}),c},t=function(a,b){var c;return f(a)?(c=[],j(a,function(a,d,e){b(a,d,e)&&c.push(a)})):(c={},j(a,function(a,d,e){b(a,d,e)&&(c[d]=a)})),c},u=function(){var a={};return j(arguments,function(b){j(b,function(b,c){a[c]=b})}),a},v=function(){var a=0;return function(){return a+=1}}(),w=function(a){a=a||{};var b={};return a.publish=function(a,c){j(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){j(b,function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)})},a},x=function(a,b){a=a||{};var c=w();return b.url=a.url,b.data=a.data,c.validate=a.validate||function(){return{}},c.get=function(a){return a?b.data[a]:i(b.data)},c.set=function(a,d,e){e=e||{};var f=e.validate===!1?{}:c.validate(d);return h(f)?(b.data=u(b.data,d),e.silent!==!0&&(c.publish("change",d),a(d,e)),!0):(e.silent!==!0&&c.publish("error",f),!1)},c},y=function(a,b){409===b.status&&a.publish("error",b.responseJSON)},z=function(a){a=a||{};var b={},c=x(a,b),d=a.id,f=a.ajax||function(a){$.ajax({url:c.isNew()?b.url:b.url+"/"+c.id(),method:a.method,data:"PUT"===a.method||"DELETE"===a.method?JSON.stringify(b.data):b.data,dataType:"json",success:a.success,error:e(y,c)})};return c.isNew=function(){return void 0===d?!0:!1},c.id=function(){return d},c.set=e(c.set,function(){}),c.clear=function(){b.data={},d=void 0,c.publish("change",c)},c.save=function(){var a=c.validate(c.get());h(a)&&f({url:c.isNew()?b.url:b.url+"/"+d,method:c.isNew()?"POST":"PUT",data:b.data,success:function(a){var b=c.isNew();d=c.isNew()?a:d,c.publish("saved",b)}}),c.publish("error",a)},c.delete=function(){console.log("delete",c.id()),c.isNew()?(c.clear(),c.publish("change",c)):f({url:b.url+"/"+d,method:"DELETE",success:function(a){console.log("delete success",a);var b=c.id();c.clear(),c.publish("destroyed",b)}})},c},A=function(a){a=a||{},a.data=a.data||{},a.data.pageNumber=a.pageNumber||1,a.data.numberOfPages=a.numberOfPages||1;var b={},c=x(a,b),d=a.requestModel;return c.validate=function(a){a=a||b.data;var c={},d=void 0!==a.numberOfPages?a.numberOfPages:b.data.numberOfPages,e=void 0!==a.pageNumber?a.pageNumber:b.data.pageNumber;return 0>=e?c.pageNumber="Page number must be greater than zero.":e>d&&(c.pageNumber="Page number must be less than or equal to the number of pages."),c},c.set=e(c.set,function(a){a.pageNumber&&d.changePage(a.pageNumber)}),c},B=function(a){a=a||{};var b={},c=x(a,b),d=a.requestModel;return c.set=e(c.set,d.search),c.toggle=function(){var a=["neutral","ascending","descending"];return function(d){var e=a.indexOf(b.data[d]),f=(e+1)%a.length,g={};g[d]=a[f],c.set(g)}}(),c},C=function(a){a=a||{};var b={},c=x(a,b),d=a.requestModel;return c.set=e(c.set,d.search),c},D=function(){var a,b,c,d,f=w(),g=function(b){b=b||{},$.ajax({url:a+"/page/"+(b.page||1),method:"GET",data:u(o("filter_",d.get()),o("order_",c.get())),dataType:"json",success:e(f.publish,"load"),error:e(y,f)})};return f.init=function(e){a=e.url,b=e.paginatorModel,d=e.filterModel,c=e.orderModel},f.changePage=function(a){g({page:a})},f.search=function(){b.set({pageNumber:1},{silent:!0}),g()},f},E=function(a,b,c){var d=v()+"-",e=function(e,f,g){g=void 0===g?!0:g;var h=function(){return"checkbox"===a.type||"radio"===a.type?'value="'+f+'" ':'value="{{'+b+'}}" '},i=function(){return"checkbox"===a.type||"radio"===a.type?'id="'+d+b+"-"+f+'" ':'id="'+d+c+"-"+b+'" '};return""+(g?'<div class="input">':"")+'<input type="'+a.type+'" '+i()+'name="'+b+'" '+h()+(e?"checked":"")+"/>"+(g?"</div>":"")},f=function(){return'<div class="input">'+s(a.values,function(a,c){return(a||"")+'<label for="'+d+b+"-"+c+'">'+c+"</label>"+"{{#"+b+"."+c+"}}"+e(!0,c,!1)+"{{/"+b+"."+c+"}}"+"{{^"+b+"."+c+"}}"+e(!1,c,!1)+"{{/"+b+"."+c+"}}"})+"</div>"};switch(a.type){case"text":return e();case"password":return e();case"textarea":return'<div class="input"><textarea id="'+d+c+"-"+b+'" '+'name="'+b+'">'+"{{"+b+"}}"+"</textarea>"+"</div>";case"checkbox":return f();case"radio":return f();case"select":return'<div class="input"><select name="'+b+'">'+s(a.values,function(a,c){return a=a||"",a+"{{#"+b+"."+c+"}}"+'<option value="'+c+'" selected>'+c+"</option>"+"{{/"+b+"."+c+"}}"+"{{^"+b+"."+c+"}}"+'<option value="'+c+'">'+c+"</option>"+"{{/"+b+"."+c+"}}"})+"</select>"+"</div>";default:throw"Invalid input type: "+a.type}},F=function(a,b){return s(a,function(a,c,d){return(a||"")+'<div class="control-set">'+'<label for="'+b+"-"+d+'" class="label">'+d+"</label>"+E(c,d,b)+'<div class="crud-help">{{'+d+"Help}}</div>"+"</div>"})},G=function(a,b){return"<form><fieldset><legend>"+b+"</legend>"+F(a,b)+'<div class="control-set">'+'<div class="label">&nbsp;</div>'+'<div class="input">'+'<input type="submit" class="js-crud-save" value="Save"/>'+'<button id="crud-new-item" type="button">'+"New "+b+"</button>"+"</div>"+"</div>"+"</fieldset>"+"</form>"},H=function(a,b){return"<form><fieldset><legend>Search "+b+"</legend>"+F(a,b)+'<div class="control-set">'+'<div class="label">&nbsp;</div>'+'<div class="input">'+'<input type="submit" class="js-crud-filter" value="Search"/>'+"</div>"+"</div>"+"</fieldset>"+"</form>"},I=function(a){return'<td><input type="checkbox" class="crud-list-selected"/></td>'+s(a,function(a,b,c){return(a||"")+'<td class="crud-list-item-column" name="'+c+'">{{'+c+"}}</td>"})},J=function(a){return'<table><thead><tr><th><label for="crud-list-select-all">All</label><input type="checkbox" id="crud-list-select-all"/></th>'+s(a,function(a,b,c){return(a||"")+"<th>"+"{{#orderable."+c+"}}"+'<a href="#" data-name="'+c+'" class="crud-order">'+"{{#order."+c+".ascending}}"+'<span  crud-order-ascending">'+"{{{orderIcon.ascending}}}"+"</span>"+"{{/order."+c+".ascending}}"+"{{#order."+c+".descending}}"+'<span class="crud-order-descending">'+"{{{orderIcon.descending}}}"+"</span>"+"{{/order."+c+".descending}}"+"{{#order."+c+".neutral}}"+'<span class="crud-order-neutral">'+"{{{orderIcon.neutral}}}"+"</span>"+"{{/order."+c+".neutral}}"+"</a>"+"{{/orderable."+c+"}}"+'<span class="crud-th-content">'+c+"</span>"+"</th>"})+"</tr>"+"</thead>"+'<tbody id="crud-list-item-container"></tbody>'+"</table>"+'<button id="crud-delete-selected">Delete Selected</button>'},K=function(){return'<div class="crud-paginator"><ol class="crud-pages">{{#pages}}<li><a data-page-number="{{.}}" href="#/page/{{.}}">{{.}}</a></li>{{/pages}}</ol><form class="crud-goto-page-form"><input type="text" name="goto-page" id="crud-goto-page" placeholder="page #"/><input type="submit" value="Go"/><div class="crud-help"></div></form></div>'},L=function(a,b){return p(b,function(b,c){var d=function(b){return a.find('[name="'+c+'"]'+(b||"")).val()};switch(b.type){case"radio":return d(":checked");case"select":return d(" option:selected");case"checkbox":var e=[];return a.find('[name="'+c+'"]:checked').each(function(){e.push($(this).val())}),e;default:return d()}})},M=function(b){var c={},d=b.el,f=function(a,b,d){b=b||c.model.get(),d=a?c.mapErrorData(u(c.model.validate(b),d)):{},c.$().html(Mustache.render(c.template,u(c.mapModelToView(b),d)))};return c.mapErrorData=function(b){return p(b,a,function(a){return a+"Help"})},c.schema=b.schema,c.model=b.model,c.template=b.template,c.$=function(a){return a?$(d).find(a):$(d)},c.mapModelToView=function(a,b){b=b||c.schema;var d=function(a,c,d){var e=b[d].type;return"radio"===e||"select"===e?a===c:-1!==c.indexOf(a)},e=p(a,function(a,c){var e=b[c].type;if("checkbox"===e||"select"===e||"radio"===e){var f={};return j(b[c].values,function(b){d(b,a,c)&&(f[b]=!0)}),f}return a});return e},c.render=e(f,!0),c.renderNoError=e(f,!1),c},N=function(a){a=a||{},a.el=a.el||"#crud-list-item-"+a.model.id();var b=w(M(a));b.isSelected=function(){return b.$(".crud-list-selected").prop("checked")?!0:!1};var c=b.mapModelToView;b.mapModelToView=function(a){return p(c(a),function(a){return g(a)?m(a,function(a,b){return b}).join(", "):a})};var d=b.render;return b.render=function(a){d(a),b.bindView()},b.select=function(){b.$().addClass("selected")},b.deselect=function(){b.$().removeClass("selected")},b.bindView=function(){b.$(".crud-list-item-column").hover(function(){b.$().addClass("hover")},function(){b.$().removeClass("hover")}),b.$(".crud-list-item-column").click(function(){b.publish("selected",b)})},b.model.subscribe("saved",function(){b.render()}),b},O=function(a){a=a||{};var b=w(M(a)),c=[],f={ascending:"&#8679;",descending:"&#8681;",neutral:"&#8691;"},g=function(){var a=b.$("#crud-list-item-container");a.html(""),j(c,function(b){var c="crud-list-item-"+b.model.id();a.append('<tr id="'+c+'" '+'class="list-item"></tr>'),b.render()}),h()},h=function(){b.$("#crud-list-select-all").unbind(),b.$("#crud-list-select-all").change(function(){b.$(".crud-list-selected").prop("checked",$(this).is(":checked"))}),b.$("#crud-delete-selected").unbind(),b.$("#crud-delete-selected").click(function(a){a.preventDefault(),j(c,function(a){a.isSelected()&&a.model.delete()})}),b.$(".crud-list-selected").unbind(),b.$(".crud-list-selected").change(function(){$("#crud-list-select-all").prop("checked",!1)}),b.$(".crud-order").unbind(),b.$(".crud-order").click(function(){b.orderModel.toggle($(this).data("name"))})};return b.orderModel=a.orderModel,b.renderNoError,b.renderNoError=function(){b.$().html(Mustache.render(b.template,{orderable:p(b.schema,e(d,"orderable")),order:p(b.orderModel.get(),function(a){return"ascending"===a?{ascending:!0}:"descending"===a?{descending:!0}:{neutral:!0}}),orderIcon:f}))},b.setSelected=function(a){j(c,function(a){a.deselect()}),a&&a.select()},b.setSelectAll=function(a){$("#crud-list-select-all").prop("checked",a)},b.add=function(a){c.push(a),g()},b.getItemControllerByID=function(a){return t(c,function(b){return b.model.id()===a})[0]},b.clear=function(){c=[]},b.remove=function(a){c=t(c,function(b){return b.model.id()!=a}),g()},b.orderModel.subscribe("change",function(a){b.$('[data-name="'+q(a)[0]+'"]').html("<span  crud-order-"+r(a)[0]+'">'+f[r(a)[0]]+"</span>")}),b},P=function(a){a=a||{};var d=M(a),e=function(){d.$("li a").unbind(),d.$("li a").click(function(){var a=Number($(this).data("page-number"));d.model.set({pageNumber:a})})};return d.setSelected=function(a){d.$("li a").removeClass("selected"),d.$("li a").each(function(){Number($(this).data("page-number"))===a&&$(this).addClass("selected")})},d.render=function(a){a=a||d.calculatePageRange();var b=d.model.validate();d.$().html(Mustache.render(d.template,{pages:a,error:b})),d.setSelected(d.model.get("pageNumber")),e()},d.setPage=function(a){d.model.set({pageNumber:a})},d.calculatePageRange=function(){var a,e=1,f=[1,12,123,1234,12345,123456,1234567],g=function(){d.$().css({visibility:"hidden"}),d.render(f);var b=d.$("li"),c=d.$(".crud-goto-page-form").width();a={digits:p(f,function(a,c){return b.eq(c).width()}),container:d.$(".crud-pages").width()-c-5,"goto":c},d.render(e),d.$().removeAttr("style")},h=function(b){return a.digits[b.toString().length-1]},i=function(a,d,e){for(var f=a,g=0,i=[],j=e?b:c;d>g;)f=j(f),g+=h(f),i.push(f);return i.pop(),i},m=function(a){var b=[];return j(k(a),function(a){0>=a?b.push(l(b)+1):b.unshift(a)}),b};return function(){g();var b=d.model.get("pageNumber"),c=(a.container-h(b))/2,e=t(m(k(i(b,c,!1)).concat([b]).concat(i(b,c,!0))),function(a){return a<=d.model.get("numberOfPages")});return e}}(),d.model.subscribe("change",function(){d.render()}),d},Q=function(a){a=a||{};var b=w(M(a)),c=a.filterSchema,d=function(){return L(b.$(),c)},e=b.mapModelToView;return b.mapModelToView=function(a){return e(a,c)},b.renderNoError(),b.$().submit(function(a){a.preventDefault(),console.log("serialize",d()),b.model.set(d())}),b},R=function(a){a=a||{},a.model=a.model||a.createDefaultModel();var b=w(M(a));b.serialize=function(){return L(b.$(),b.schema)};var c=function(){b.$().unbind(),b.$().submit(function(a){a.preventDefault(),b.model.set(b.serialize()),b.model.save()}),$("#crud-new-item").unbind(),$("#crud-new-item").click(function(){b.setModel(a.createDefaultModel()),b.publish("new")})};c();var d=function(){var a=b.$("#crud-new-item");b.model.isNew()&&!a.is(":hidden")?a.hide():!b.model.isNew()&&a.is(":hidden")&&a.show()},e=b.render;b.render=function(a,b){e(a,b),d(),c()};var f=b.renderNoError;return b.renderNoError=function(a){f(a),b.$("#crud-new-item").hide(),d(),c()},b.setModel=function(){var a=d,c=function(){b.render()},e=function(a){b.render(b.model.get(),a)};return function(d){b.model.unsubscribe(c),b.model.unsubscribe(a),b.model.unsubscribe(e),d.subscribe("change",c),d.subscribe("saved",a),d.subscribe("error",e),b.model=d,d.isNew()?b.renderNoError():b.render()}}(),b.setModel(b.model),b};this.createCRUD=function(a){a=a||{};var b={},c=a.url,f=a.name,g=function(a){return"checkbox"===a.type&&(a.value=a.value||[]),a},h=p(a.schema,g),i=p(a.filterSchema,g),k=a.validate,l=function(a,b){return z({id:b,url:c,data:a||p(h,function(a){return a.value||null}),validate:k})};b.listTemplate=a.listTemplate||J(h,f),b.listItemTemplate=a.listItemTemplate||I(h,f),b.formTemplate=a.formTemplate||G(h,f),b.paginatorTemplate=a.paginatorTemplate||K(),b.filterTemplate=a.filterTemplate||H(i,f);var m=D(),n=A({requestModel:m}),o=C({requestModel:m,data:p(i,function(a){return"checkbox"===a.type&&(a.value=a.value||[]),void 0===a.value?null:a.value})});Q({el:"#"+f+"-crud-filter-container",model:o,filterSchema:i,template:b.filterTemplate});var q=P({el:"#"+f+"-crud-paginator-nav",model:n,template:b.paginatorTemplate});q.render();var r=B({data:p(t(h,e(d,"orderable")),function(a){return a.order||"neutral"}),requestModel:m});m.init({url:c,paginatorModel:n,filterModel:o,orderModel:r});var s=O({el:"#"+f+"-crud-list-container",schema:h,model:l(),orderModel:r,createModel:l,template:b.listTemplate});s.renderNoError();var u=function(a){return a.subscribe("saved",function(b){b&&y(a)}),a.subscribe("destroyed",function(a){console.log("destroyed",a),s.remove(a),s.setSelectAll(!1)}),a},v=R({el:"#"+f+"-crud-container",schema:h,createDefaultModel:function(){return u(l())},template:b.formTemplate});v.subscribe("new",function(){s.setSelected()});var w=function(a){v.setModel(a)},x=function(a){s.setSelected(a),w(a.model)},y=function(a){var c=N({model:a,schema:h,template:b.listItemTemplate});c.subscribe("selected",x),s.add(c),s.setSelected(c),u(a)};b.newItem=function(){var a=l();w(a),u(a)};var E=function(a){s.clear(),j(a,function(a){var b=a.id;delete a.id,y(l(a,b)),s.setSelected()})},F=function(a){console.log("load",a),E(a.data),q.model.set({numberOfPages:a.pages})};return b.init=function(){b.newItem(),m.subscribe("load",F),q.setPage(1)},b}}).call(this);