// crud
// https://github.com/DubFriend/CRUD.git
// 10-19-2013
(function(){"use strict";var a=function(a){return a},b=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}},c=function(a){return a instanceof Array},d=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},e=function(a){return JSON.parse(JSON.stringify(a))},f=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},g=function(a,b,d){var e;return c(a)?(e=[],f(a,function(a,c,d){e.push(b(a,c,d))})):(e={},f(a,function(a,c,f){c=d?d(c):c,e[c]=b(a,c,f)})),e},h=function(a,b){var c;return f(a,function(d,e){c=b(c,d,e,a)}),c},i=function(){var a={};return f(arguments,function(b){f(b,function(b,c){a[c]=b})}),a},j=function(a){a=a||{};var b={};return a.publish=function(a,c){f(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){f(b,function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)})},a},k=function(a){a=a||{};var b=j(),c=a.url,g=a.data||{},h=a.id||void 0,i=function(a){$.ajax({url:c,method:a.method,data:a.data,dataType:"json",success:a.success,error:function(){console.error("crud ajax error",arguments),b.publish("ajaxError",arguments)}})};return b.isNew=function(){return void 0===h?!0:!1},b.id=function(){return h},b.get=function(a){return a?g[a]:e(g)},b.set=function(a){f(a,function(b,c){a[c]=b}),b.publish("change",b)},b.clear=function(){g={},h=void 0},b.validate=a.validate||function(){return{}},b.save=function(){var a=b.validate();d(a)&&i({url:b.isNew()?c:c+"/"+h,method:b.isNew()?"POST":"PUT",data:g,success:function(a){h=b.isNew()?a:h,b.publish("saved",b)}}),b.publish("formError",a)},b.delete=function(){b.isNew()||i({method:"DELETE",data:{id:h},success:function(){b.publish("destroyed",b)}}),b.clear()},b},l=function(a,b){var c=function(a,c){var d=function(d,e,f){f=void 0===f?!0:f;var g=function(){return"checkbox"===a.type||"radio"===a.type?'value="'+e+'" ':'value="{{'+c+'}}" '},h=function(){return"checkbox"===a.type||"radio"===a.type?'id="'+c+"-"+e+'" ':'id="'+b+"-"+c+'" '};return""+(f?'<div class="input">':"")+'<input type="'+a.type+'" '+h()+'name="'+c+'" '+g()+(d?"checked":"")+"/>"+(f?"</div>":"")},e=function(){return'<div class="input">'+h(a.values,function(a,b){return a=a||"",a+'<label for="'+c+"-"+b+'">'+b+"</label>"+"{{#"+c+"."+b+"}}"+d(!0,b,!1)+"{{/"+c+"."+b+"}}"+"{{^"+c+"."+b+"}}"+d(!1,b,!1)+"{{/"+c+"."+b+"}}"})+"</div>"};switch(a.type){case"text":case"password":return d();case"textarea":return'<div class="input"><textarea id="'+b+"-"+c+'" '+'name="'+c+'">'+"{{"+c+"}}"+"</textarea>"+"</div>";case"checkbox":case"radio":return e();case"select":return'<div class="input"><select name="'+c+'">'+h(a.values,function(a,b){return a=a||"",a+"{{#"+c+"."+b+"}}"+'<option value="'+b+'" selected>'+b+"</option>"+"{{/"+c+"."+b+"}}"+"{{^"+c+"."+b+"}}"+'<option value="'+b+'">'+b+"</option>"+"{{/"+c+"."+b+"}}"})+"</select>"+"</div>";default:throw"Invalid input type: "+a.type}};return"<form><fieldset><legend>"+b+"</legend>"+h(a,function(a,d,e){return a=a||"",a+'<div class="control-set">'+'<label for="'+b+"-"+e+'" class="label">'+e+"</label>"+c(d,e)+'<div class="crud-help">{{'+e+"Help}}</div>"+"</div>"})+'<div class="control-set">'+'<div class="label">&nbsp;</div>'+'<div class="input">'+'<input type="submit" value="Save"/>'+"</div>"+"</div>"+"</fieldset>"+"</form>"},m=function(a){return'<table><thead><tr><th><label for="crud-list-select-all">All</label><input type="checkbox" id="crud-list-select-all"/></th>'+h(a,function(a,b,c){return a=a||"",a+"<th>"+c+"</th>"})+"</tr>"+"</thead>"+"<tbody></tbody>"+"</table>"},n=function(c){var d={},e=c.el;d.schema=c.schema,d.model=c.model,d.template=c.template,d.$=function(a){return a?$(e).find(a):$(e)},d.mapModelToView=function(a){var b=function(a,b,c){var e=d.schema[c].type;return"radio"===e||"select"===e?a===b:-1!==b.indexOf(a)};return g(a,function(a,c){var e=d.schema[c].type;if("checkbox"===e||"select"===e||"radio"===e){var g={};return f(d.schema[c].values,function(d){b(d,a,c)&&(g[d]=!0)}),g}return a})};var h=function(b,c){c=c||d.model.get(),d.$().html(Mustache.render(d.template,i(d.mapModelToView(c),b?g(d.model.validate(c),a,function(a){return a+"Help"}):{})))};return d.render=b(h,!0),d.renderNoError=b(h,!1),d},o=function(a){a=a||{};var b=n(a);return b},p=function(a){a=a||{};var b=n(a);return b.serialize=function(){return g(b.schema,function(a,c){var d=function(a){return b.$('[name="'+c+'"]'+(a||"")).val()},e=function(){var a=[];return b.$('[name="'+c+'"]:checked').each(function(){a.push($(this).val())}),a};switch(a.type){case"radio":return d(":checked");case"select":return d(" option:selected");case"checkbox":return e();default:return b.$('[name="'+c+'"]').val()}})},b};this.createCRUD=function(a){a=a||{};var b={},c=a.name,d=a.schema,e=a.validate,f=k({data:g(d,function(a){return a.value||null}),validate:e});b.formTemplate=a.formTemplate||l(d,c),b.listTemplate=a.listTemplate||m(d,c);var h=p({el:"#"+c+"-crud-container",schema:d,model:f,template:b.formTemplate}),i=o({el:"#"+c+"-crud-list-container",schema:d,model:f,template:b.listTemplate});return b.init=function(){h.renderNoError(),i.renderNoError()},b.render=function(a){h.render(a),i.render(a)},b.serialize=function(){return h.serialize()},b}}).call(this);