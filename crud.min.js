// crud version 0.4.0
// (MIT) 02-12-2013
// https://github.com/DubFriend/CRUD
(function(){"use strict";var a=function(a){return a},b=function(a){return a+=1},c=function(a){return a-=1},d=function(a,b){return b[a]},e=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}},f=function(a){return a instanceof Array},g=function(a){return!f(a)&&a instanceof Object},h=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},i=function(a){return!isNaN(a)},j=function(a){return i(a)&&Number(a)%1===0},k=function(a){return JSON.parse(JSON.stringify(a))},l=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},m=function(a){var b,c=[];for(b=a.length-1;b>=0;b-=1)c.push(a[b]);return c},n=function(a){return a[a.length-1]},o=function(a,b){var c=[];return l(a,function(a,d,e){c.push(b(a,d,e))}),c},p=function(a,b,c){var d={};return l(a,function(a,e,f){e=c?c(e,a):e,d[e]=b(a,e,f)}),d},q=function(b,c){return r(c,a,function(a){return b+a})},r=function(a,b,c){return f(a)?o(a,b):p(a,b,c)},s=function(a){return o(a,function(a,b){return b})},t=function(a){return o(a,function(a){return a})},u=function(a,b){var c;return l(a,function(d,e){c=b(c,d,e,a)}),c},v=function(a,b){var c;return f(a)?(c=[],l(a,function(a,d,e){b(a,d,e)&&c.push(a)})):(c={},l(a,function(a,d,e){b(a,d,e)&&(c[d]=a)})),c},w=function(){var a={};return l(arguments,function(b){l(b,function(b,c){a[c]=b})}),a},x=function(a,b){var c=null;return function(){var d=this,e=arguments;null===c&&(c=setTimeout(function(){c=null},a),b.apply(d,e))}},y=function(a,b,c){var d=null,e=!1;return function(){var f=this,g=arguments;null===d?(d=setTimeout(function(){(!c||e)&&b.apply(f,g),e=!1,d=null},a),c&&b.apply(f,g)):e=!0}},z=function(){var a=0;return function(){return a+=1}}(),A=function(a){a=a||{};var b={};return a.publish=function(a,c){l(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){l(b,function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)})},a},B=function(a,b){a=a||{};var c=A();return b.url=a.url,b.data=a.data,c.validate=a.validate||function(){return{}},c.get=function(a){return a?b.data[a]:k(b.data)},c.set=function(a,d,e){e=e||{};var f=e.validate===!1?{}:c.validate(d);return h(f)?(b.data=w(b.data,d),e.silent!==!0&&(c.publish("change",d),a(d,e)),!0):(e.silent!==!0&&c.publish("error",f),!1)},c},C=function(a,b){409===b.status&&a.publish("error",b.responseJSON)},D=function(a){a=a||{};var b={},c=B(a,b),d=a.id,f=(a.deletable,a.isSoftREST),g=a.ajax||function(a){var d,g,h=c.isNew()?b.url:b.url+"/"+c.id();f?(h+="?method="+a.method,d="POST",g=b.data):(d=a.method,g="PUT"===a.method||"DELETE"===a.method?JSON.stringify(b.data):b.data),$.ajax({url:h,method:d,data:g,dataType:"json",beforeSend:e(c.publish,"form:waiting:start"),success:a.success,error:e(C,c),complete:e(c.publish,"form:waiting:end")})};return c.isNew=function(){return void 0===d?!0:!1},c.id=function(){return d},c.set=e(c.set,function(){}),c.clear=function(){b.data={},d=void 0,c.publish("change",c)},c.save=function(){var a=c.validate(c.get());h(a)&&g({url:c.isNew()?b.url:b.url+"/"+d,method:c.isNew()?"POST":"PUT",data:b.data,success:function(a){var b=c.isNew();d=c.isNew()?a:d,c.publish("saved",b)}}),c.publish("error",a)},c.delete=function(){console.log("delete",c.id()),c.isNew()?(c.publish("destroyed"),c.clear()):g({url:b.url+"/"+d,method:"DELETE",success:function(a){console.log("delete success",a);var b=c.id();c.publish("destroyed",b)}})},c},E=function(){var a,b,c,d,f=A(),g=function(b){b=b||{},$.ajax({url:a+"/page/"+(b.page||1),method:"GET",data:w(d?q("filter_",d.get()):{},q("order_",c.get())),dataType:"json",beforeSend:e(f.publish,b.moduleName+":waiting:start"),success:e(f.publish,"load"),error:e(C,f),complete:e(f.publish,b.moduleName+":waiting:end")})};return f.init=function(e){a=e.url,b=e.paginatorModel,d=e.filterModel,c=e.orderModel},f.changePage=function(a,b){g({page:a,moduleName:b})},f.search=function(a){1!==b.get("pageNumber")&&b.set({pageNumber:1}),g({moduleName:a})},f},F=function(a){a=a||{};var b={},c=B(a,b),d=a.requestModel;return c.set=e(c.set,e(d.search,"filter")),c},G=function(a){a=a||{};var b={},c=B(a,b),d=a.requestModel;return c.set=e(c.set,e(d.search,"order")),c.toggle=function(){var a=["neutral","ascending","descending"];return function(d){var e=a.indexOf(b.data[d]),f=(e+1)%a.length,g={};g[d]=a[f],c.set(g)}}(),c},H=function(a){a=a||{},a.data=a.data||{},a.data.pageNumber=a.pageNumber||1,a.data.numberOfPages=a.numberOfPages||1;var b={},c=B(a,b),d=a.requestModel;return c.validate=function(a){a=a||b.data;var c={},d=void 0!==a.numberOfPages?a.numberOfPages:b.data.numberOfPages,e=void 0!==a.pageNumber?a.pageNumber:b.data.pageNumber;return 0>=e?c.pageNumber="Page number must be greater than zero.":e>d&&(c.pageNumber="Page number must be less than or equal to the number of pages."),c},c.set=e(c.set,function(a){a.pageNumber&&(c.publish("change:pageNumber",a),d.changePage(a.pageNumber,"paginator"))}),c},I=function(a){a=a||{};var b={},c=B(a,b);return c.set=e(c.set,function(){}),c.clear=function(){b.data={},c.publish("change",c)},c.submit=function(){var a=c.validate(c.get());h(a)&&$.ajax({url:b.url,method:"POST",data:b.data,dataType:"json",beforeSend:e(c.publish,"waiting:start"),success:function(a){console.log("success",a),c.publish("posted",a)},error:e(C,c),complete:e(c.publish,"waiting:end")}),c.publish("error",a)},c},J=function(a){var b=a.item,c=b.name,d=a.name,e=a.class||"",f=a.ID?a.ID+"-":z()+"-",g=function(a,g){var h=function(){return"checkbox"===b.type||"radio"===b.type?'value="'+g+'" ':'value="{{'+c+'}}" '},i=function(){return"checkbox"===b.type||"radio"===b.type?'id="'+f+c+"-"+g+'" ':'id="'+f+d+"-"+c+'" '};return'<input type="'+b.type+'" '+i()+'name="'+c+'" '+h()+' class="'+e+'" '+(a?"checked":"")+"/>"},h=function(){return""+u(b.values,function(a,b){var d=b.value;return(a||"")+'<label for="'+f+c+"-"+d+'">'+(b.label||d)+"</label>{{#"+c+"."+d+"}}"+g(!0,d)+"{{/"+c+"."+d+"}}{{^"+c+"."+d+"}}"+g(!1,d)+"{{/"+c+"."+d+"}}"})};switch(b.type){case"text":return g();case"password":return g();case"textarea":return'<textarea id="'+f+d+"-"+c+'" name="'+c+'" class="'+e+'">{{'+c+"}}</textarea>";case"checkbox":return h();case"radio":return h();case"select":return'<select name="'+c+'" class="'+e+'">'+u(b.values,function(a,b){var d=b.value;return a=a||"",a+"{{#"+c+"."+d+'}}<option value="'+d+'" selected>'+(b.label||d)+"</option>{{/"+c+"."+d+"}}{{^"+c+"."+d+'}}<option value="'+d+'">'+(b.label||d)+"</option>{{/"+c+"."+d+"}}"})+"</select>";default:throw"Invalid input type: "+b.type}},K=function(a,b){return u(a,function(a,c){return(a||"")+'<div class="crud-control-set"><label for="'+b+"-"+c.name+'">'+(c.label||c.name)+'</label><div class="crud-input-group">'+J({item:c,name:b,"class":"foo"})+'</div><div class="crud-help">{{'+c.name+"Help}}</div></div>"})},L=function(){return'<div class="crud-delete-modal modal"><div class="crud-modal-dialogue"><p class="crud-message">Are you sure you want to delete the selected items?</p><center><button class="crud-confirm-delete">Delete</button><button class="crud-cancel-delete">Cancel</button></center></div></div>'},M=function(a,b,c){return"<form><fieldset><legend>Search "+b+"</legend>"+K(a,b)+'<div class="crud-control-set"><div class="label">&nbsp;</div>'+(c?"":'<div class="crud-input-group"><input type="submit" value="Search"/></div>')+"</div></fieldset></form>"},N=function(a,b){return"<form><fieldset><legend>"+b+'</legend><span class="crud-status">{{status}}</span>'+K(a,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group"><input type="submit" value="Save"/><button class="crud-close-form">Close</button></div></div></fieldset></form>'},O=function(a,b,c){return""+L()+"<form><fieldset><legend>"+b+'</legend><span class="crud-status">{{status}}</span>'+K(a,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group"><input type="submit" value="Save"/>'+(c?'<button class="crud-delete">Delete</button>':"")+'</div><div class="success">{{successMessage}}</div></div></fieldset></form>'},P=function(a){return"{{#orderable."+a+'}}<a href="#" data-name="'+a+'" class="crud-order">{{#order.'+a+".ascending}}{{{orderIcon.ascending}}}{{/order."+a+".ascending}}{{#order."+a+".descending}}{{{orderIcon.descending}}}{{/order."+a+".descending}}{{#order."+a+".neutral}}{{{orderIcon.neutral}}}{{/order."+a+".neutral}}</a>{{/orderable."+a+"}}"},Q=function(a,b,c,d,e){var f=z();return"<table><thead><tr>"+(e?"":"<th>"+(d?'<label for="'+f+'-crud-list-select-all">All</label><input type="checkbox" id="'+f+'-crud-list-select-all" class="crud-list-select-all"/>':"")+"</th>")+(c?"<th>"+P("id")+'<span class="crud-th-content">'+(c.label||"id")+"</span></th>":"")+u(a,function(a,b){return(a||"")+"<th>"+P(b.name)+'<span class="crud-th-content">'+(b.label||b.name)+"</span></th>"})+'</tr></thead><tbody class="crud-list-item-container"></tbody></table>'+(d?'<button class="crud-delete-selected">Delete Selected</button>':"")},R=function(a,b,c,d){return""+(d?"":"<td>"+(c?'<input type="checkbox" class="crud-list-selected"/>':"")+(d?"":'<input type="button" class="crud-edit-button" value="Edit"/>')+"</td>")+(b?'<td name="id">{{id}}</td>':"")+u(a,function(a,b){return(a||"")+'<td name="'+b.name+'">{{'+b.name+"}}</td>"})},S=function(){return'<div class="crud-paginator"><ol class="crud-pages">{{#pages}}<li><a data-page-number="{{.}}" href="#">{{.}}</a></li>{{/pages}}</ol><form class="crud-goto-page-form"><span class="number-of-pages">pages: {{numberOfPages}}</span><input type="text" name="goto-page" placeholder="page #"/><input type="submit" value="Go"/><div class="crud-help"></div></form></div>'},T=function(a,b){return"<form><fieldset><legend>"+b+"</legend>"+K(a,b)+'<div class="crud-control-set"><label>&nbsp;</label><div class="crud-input-group"><input type="submit" value="Submit"/></div><div class="success">{{successMessage}}</div></div></fieldset></form>'},U=function(a,b){return r(b,function(b,c){var d=function(b){return a.find('[name="'+c+'"]'+(b||"")).val()};switch(b.type){case"radio":return d(":checked");case"select":return d(" option:selected");case"checkbox":var e=[];return a.find('[name="'+c+'"]:checked').each(function(){e.push($(this).val())}),e;default:return d()}})},V=function(b){var c=A(),d=b.el,f=function(a,b,d,e){b=b||c.model.get(),d=a?c.mapErrorData(w(c.model.validate(b),d)):{},c.$().html(Mustache.render(c.template,w(c.mapModelToView(b),d,e||{})))};return c.setEl=function(a){d=a},c.mapErrorData=function(b){return r(b,a,function(a){return a+"Help"})},c.mapSchema=function(a){return p(a,function(a){return v(a,function(a,b){return"name"!==b})},function(a,b){return b.name})},c.schema=c.mapSchema(b.schema),c.model=b.model,c.template=b.template,c.$=function(a){return a?$(d).find(a):$(d)},c.mapModelToView=function(a,b){b=b||c.schema;var d=function(a,c,d){var e=b[d].type;return"radio"===e||"select"===e?a===c:-1!==c.indexOf(a)},e=r(a,function(a,c){var e=b[c].type;if("checkbox"===e||"select"===e||"radio"===e){var f={};return l(b[c].values,function(b){var e=g(b)?b.value:b;d(e,a,c)&&(f[e]=!0)}),f}return a});return e},c.render=e(f,!0),c.renderNoError=e(f,!1),c},W=function(a){a=a||{};var b=V(a),c=b.mapSchema(a.filterSchema),d=a.isInstantFilter,f=function(){return U(b.$(),c)},g=b.mapModelToView,h=e(y,500,function(){b.model.set(f())});return b.mapModelToView=function(a){return g(a,c)},b.renderNoError(),d&&l(c,function(a,c){var d=b.$('[name="'+c+'"]');switch(a.type){case"text":case"password":case"textarea":d.keyup(h(!1));break;case"radio":case"checkbox":case"select":d.change(h(!0));break;default:throw"Invalid item type: "+a.type}}),b.$().submit(function(a){a.preventDefault(),b.model.set(f())}),b},X=function(a,b){a=a||{},b=b||{},a.model=a.model||a.createDefaultModel();var c=V(a),d=a.modal;c.serialize=function(){return U(c.$(),c.schema)},c.open=function(){d.open(c.$())},c.close=function(){d.close(c.$())},b.bind=function(){c.$().unbind(),c.$().submit(function(a){a.preventDefault(),c.model.set(c.serialize(),{validate:!1}),c.model.save()}),c.$(".crud-close-form").unbind(),c.$(".crud-close-form").click(function(a){a.preventDefault(),c.close()}),c.publish("bind")},b.bind();var e=function(){c.model.isNew()?(c.$("*").removeClass("crud-status-edit"),c.$("*").addClass("crud-status-create")):(c.$("*").addClass("crud-status-edit"),c.$("*").removeClass("crud-status-create"))},f=c.render;c.render=function(a,d,g){f(a,d,w({status:c.model.isNew()?"Create":"Edit"},g)),e(),b.bind()};var g=c.renderNoError;return c.renderNoError=function(a){g(a,void 0,{status:c.model.isNew()?"Create":"Edit"}),c.$(".crud-new-item").hide(),e(),b.bind()},c.setModel=function(){var a=function(){e(),c.close()},b=function(){c.render()},d=function(a){c.render(c.model.get(),a)};return function(e){c.model.unsubscribe(b),c.model.unsubscribe(a),c.model.unsubscribe(d),e.subscribe("change",b),e.subscribe("saved",a),e.subscribe("error",d),c.model=e,e.isNew()?c.renderNoError():c.render()}}(),c},Y=function(a){var b={},c=X(a,b),d=a.modal,e=(a.deleteConfirmationTemplate,function(){d.open(c.$(".crud-delete-modal"))}),f=function(){d.close(c.$(".crud-delete-modal"))};c.model.subscribe("saved",function(){c.render(c.model.get(),{},{successMessage:"Save Successfull."}),setTimeout(function(){c.render(c.model.get(),{})},5e3)}),c.setModel(c.model);var g=b.bind;return b.bind=function(){c.$(".crud-delete").unbind(),c.$(".crud-delete").click(function(a){a.preventDefault(),e()}),c.$(".crud-confirm-delete").unbind(),c.$(".crud-confirm-delete").click(function(a){a.preventDefault(),c.model.delete(),f()}),c.$(".crud-cancel-delete").unbind(),c.$(".crud-cancel-delete").click(function(a){a.preventDefault(),f()}),g()},c},Z=function(a){a=a||{};var b=V(a),c=[],f=a.isIDOrderable===!0?!0:!1,g={ascending:"&#8679;",descending:"&#8681;",neutral:"&#8691;"},h=a.modal,i=a.deleteConfirmationTemplate,j=function(){h.open($(".crud-delete-modal"))},k=function(){h.close($(".crud-delete-modal"))},m=function(){$(".crud-cancel-delete").unbind(),$(".crud-confirm-delete").unbind(),$(".crud-cancel-delete").click(k),$(".crud-confirm-delete").click(function(){l(c,function(a){a.isSelected()&&a.model.delete()}),k()})},n=function(){b.$(".crud-list-select-all").unbind(),b.$(".crud-list-select-all").change(function(){b.$(".crud-list-selected").prop("checked",$(this).is(":checked"))}),b.$(".crud-delete-selected").unbind(),b.$(".crud-delete-selected").click(j),b.$(".crud-list-selected").unbind(),b.$(".crud-list-selected").change(function(){$(".crud-list-select-all").prop("checked",!1)}),b.$(".crud-order").unbind(),b.$(".crud-order").click(function(a){a.preventDefault(),b.orderModel.toggle($(this).data("name"))}),b.publish("bind")};$("body").prepend(Mustache.render(i)),m(),b.orderModel=a.orderModel;b.renderNoError;return b.renderNoError=function(){var a={orderable:w({id:f},r(b.schema,e(d,"orderable"))),order:w(r(b.orderModel.get(),function(a){return"ascending"===a?{ascending:!0}:"descending"===a?{descending:!0}:{neutral:!0}})),orderIcon:g};b.$().html(Mustache.render(b.template,a))},b.renderItems=function(){var a=b.$(".crud-list-item-container");a.html(""),l(c,function(b){var c="crud-list-item-"+b.model.id();a.append('<tr id="'+c+'"></tr>'),b.render()}),n()},b.setSelected=function(a){l(c,function(a){a.deselect()}),a&&a.select(),b.selectedItem=a},b.setNextSelected=function(){var a=c.indexOf(b.selectedItem||c[0]);if(-1!==a&&a+1<c.length){var d=c[a+1];d.publish("selected",d)}},b.setPreviousSelected=function(){var a=c.indexOf(b.selectedItem||c[1]);if(a>0){var d=c[a-1];d.publish("selected",d)}},b.setSelectAll=function(a){$(".crud-list-select-all").prop("checked",a)},b.add=function(a,b){b=b||{},b.prepend===!0?c.unshift(a):c.push(a)},b.getItemControllerByID=function(a){return v(c,function(b){return b.model.id()===a})[0]},b.clear=function(){c=[]},b.remove=function(a){c=v(c,function(b){return b.model.id()!=a})},b.orderModel.subscribe("change",function(a){b.$('[data-name="'+s(a)[0]+'"]').html("<span  crud-order-"+t(a)[0]+'">'+g[t(a)[0]]+"</span>")}),b},_=function(a){a=a||{},a.el=a.el||"#crud-list-item-"+a.model.id();var b=V(a);b.isSelected=function(){return b.$(".crud-list-selected").prop("checked")?!0:!1};var c=function(a,c){{var d;b.schema[a]}return l(b.schema[a].values,function(a){a.value===c&&(d=a.label||a.value)}),d},d=b.mapModelToView;b.mapModelToView=function(a){return w({id:b.model.id()},r(d(a),function(a,b){return g(a)?o(a,function(a,d){return c(b,d)}).join(", "):a}))};var e=b.render;return b.render=function(a){e(a),b.bindView()},b.select=function(){b.$().addClass("selected")},b.deselect=function(){b.$().removeClass("selected")},b.bindView=function(){b.$().hover(function(){b.$().addClass("hover")},function(){b.$().removeClass("hover")}),b.$().click(function(){b.publish("selected",b)}),b.$().dblclick(function(){b.publish("edit",b)}),b.$(".crud-edit-button").click(function(){b.publish("edit",b)}),b.publish("bind")},b.model.subscribe("saved",function(){b.render()}),b},ab=function(a){a=a||{};var d=V(a),e=function(){d.$("li a").unbind(),d.$("li a").click(function(a){a.preventDefault();var b=Number($(this).data("page-number"));d.model.set({pageNumber:b})}),d.$(".crud-goto-page-form").unbind(),d.$(".crud-goto-page-form").submit(function(a){a.preventDefault();var b=d.$(".crud-goto-page-form").find('[name="goto-page"]'),c=b.val();j(c)?d.model.set({pageNumber:Number(c)}):b.val("")}),d.publish("bind")};return d.setSelected=function(a){d.$("li a").removeClass("selected"),d.$('li a[data-page-number="'+a+'"]').addClass("selected")},d.render=function(a){a=a||d.calculatePageRange();var b=d.model.validate();d.$().html(Mustache.render(d.template,{pages:a,numberOfPages:d.model.get("numberOfPages"),error:b})),d.setSelected(d.model.get("pageNumber")),e()},d.setPage=function(a){d.model.set({pageNumber:a})},d.setNextPage=x(300,function(){var a=d.model.get("pageNumber");a+1<=d.model.get("numberOfPages")&&d.setPage(a+1)}),d.setPreviousPage=x(300,function(){var a=d.model.get("pageNumber");a>1&&d.setPage(a-1)}),d.calculatePageRange=function(){var a,e=1,f=[1,12,123,1234,12345,123456,1234567],g=function(){d.$().css({visibility:"hidden"}),d.render(f);var b=d.$("li"),c=d.$(".crud-goto-page-form").width();a={digits:r(f,function(a,c){return b.eq(c).width()}),container:d.$(".crud-pages").width()-c-5,"goto":c},d.render(e),d.$().removeAttr("style")},h=function(b){return a.digits[b.toString().length-1]},i=function(a,d,e){for(var f=a,g=0,i=[],j=e?b:c;d>g;)f=j(f),g+=h(f),i.push(f);return i.pop(),i},j=function(a){var b=[];return l(m(a),function(a){0>=a?b.push(n(b)+1):b.unshift(a)}),b},o=function(b){var c=k(b),e=u(c,function(a,b){return(a||0)+h(b)}),f=a.container-e,g=n(c)+1;return f>h(g)&&g<=d.model.get("numberOfPages")?c.push(g):0>f&&c.pop(),c};return function(){g();var b=d.model.get("pageNumber"),c=(a.container-h(b))/2,e=o(v(j(m(i(b,c,!1)).concat([b]).concat(i(b,c,!0))),function(a){return a<=d.model.get("numberOfPages")}));return e}}(),d.model.subscribe("change",function(){d.render()}),d},bb=function(a){a=a||{};var b=V(a);b.serialize=function(){return U(b.$(),b.schema)};var c=function(){b.$().unbind(),b.$().submit(function(a){a.preventDefault(),b.model.set(b.serialize(),{validate:!1}),b.model.submit()}),b.publish("bind")};c();var d=b.render;b.render=function(a,b,e){d(a,b,e),c()};var e=b.renderNoError;return b.renderNoError=function(a){e(a),c()},b.model.subscribe("change",b.render),b.model.subscribe("error",function(a){b.render(b.model.get(),a)}),b.renderNoError(),b};this.CRUD=function(){var b=function(a,b){return b?!1:a===!1?!1:!0},c=function(a){return"checkbox"===a.type&&(a.value=a.value||[]),a},f=function(a){return r(a,function(a){var b=k(a);switch(b.type){case"radio":case"checkbox":case"select":b.values=r(b.values,e(d,"value"))}return b})},g=function(a){return p(a,function(a){return a.value||null},function(a,b){return b.name})},h=function(a,b,c){return D({id:c,url:a.url,isSoftREST:a.isSoftREST,data:b||g(a.schema),validate:a.validate})},i={open:function(a){a.modal({fadeDuration:200,fadeDelay:0,showClose:!1})},close:function(){$.modal.close()}};return{full:function(g){g=g||{};var j,k,m,n=A(),o=g.url,q=g.name,s=g.id||!1,t=g.instantFilter||!1,u=g.readOnly||!1,x=b(g.deletable,u),y=g.isSoftREST||!1,B=g.modal||i,C=r(g.schema,c),D=r(g.filterSchema,c),I=f(C),K=f(D),O=g.validate,T=e(h,{url:o,isSoftREST:y,schema:I,validate:O}),U=function(a){qb.setSelected(a),u||gb(a.model)},V=function(a){U(a),sb.open()},Y=function(a,b){b=b||{};var c=_({model:a,schema:C,template:jb});return c.subscribe("selected",U),c.subscribe("edit",V),qb.add(c,b),qb.setSelected(c),fb(a),c},bb=function(a){qb.clear(),l(a,function(a){var b=a.id;delete a.id,Y(T(a,b)),qb.setSelected()}),qb.renderItems()},cb=function(){var a=!0;return function(b){bb(b.data),pb.model.set({numberOfPages:b.pages}),a&&(pb.render(),a=!1)}}(),db=function(a,b){return e(n.publish,"bind:"+b,a.$)},eb=function(a,b){a.subscribe(b+":waiting:start",e(n.publish,b+":waiting:start")),a.subscribe(b+":waiting:end",e(n.publish,b+":waiting:end"))},fb=function(a){return a.subscribe("saved",function(b){if(b){var c=Y(a,{prepend:!0});qb.renderItems(),qb.setSelected(c)}}),a.subscribe("destroyed",function(a){qb.remove(a),qb.setSelectAll(!1),qb.renderItems(),hb()}),eb(a,"form"),a},gb=function(a){sb.setModel(a)},hb=function(){var a=T();u||gb(a),fb(a)},ib=g.createListTemplate?g.createListTemplate.apply({schema:I,name:q,id:s,deletable:x,readOnly:u,orderable:P,uniqueID:z}):Q(C,q,s,x,u),jb=g.createListItemTemplate?g.createListItemTemplate.apply({schema:C,id:s,deletable:x,readOnly:u}):R(C,s,x,u),kb=g.createPaginatorTemplate?g.createPaginatorTemplate():S(),lb=g.createDeleteConfirmationTemplate?g.createDeleteConfirmationTemplate():L(),mb=E(),nb=H({requestModel:mb}),ob=G({data:r(w({id:s},v(p(I,a,function(a,b){return b.name}),e(d,"orderable"))),function(a){return a.order||"neutral"}),requestModel:mb}),pb=ab({el:"#"+q+"-crud-paginator-nav",model:nb,template:kb}),qb=Z({el:"#"+q+"-crud-list-container",schema:I,modal:B,isIDOrderable:s&&s.orderable?!0:!1,model:T(),orderModel:ob,createModel:T,template:ib,deleteConfirmationTemplate:lb});g.filterSchema&&(j=g.createFilterTemplate?g.createFilterTemplate.apply({filterSchema:D,name:q,createInput:J,isInstantFilter:t,uniqueID:z}):M(D,q,t),k=F({requestModel:mb,data:p(K,function(a){return"checkbox"===a.type&&(a.value=a.value||[]),void 0===a.value?null:a.value},function(a,b){return b.name})}),m=W({el:"#"+q+"-crud-filter-container",model:k,filterSchema:D,isInstantFilter:t,template:j}),k.subscribe("change",hb),m.subscribe("bind",db(m,"filter")));var rb,sb;return u?sb={open:function(){},close:function(){}}:($("#"+q+"-crud-new").html(g.newButtonHTML||"<button>Create New "+q+"</button>"),$("#"+q+"-crud-new").find("button").click(function(){hb(),sb.publish("new"),sb.open()}),rb=g.createFormTemplate?g.createFormTemplate.apply({schema:C,name:q,createInput:J,uniqueID:z}):N(C,q),sb=X({el:"#"+q+"-crud-container",schema:I,modal:B,createDefaultModel:function(){return fb(T())},template:rb}),sb.subscribe("new",function(){qb.setSelected()}),sb.subscribe("bind",db(sb,"form")),nb.subscribe("change",hb)),mb.init({url:o,paginatorModel:nb,filterModel:k,orderModel:ob}),qb.renderNoError(),qb.subscribe("bind",db(qb,"list")),pb.subscribe("bind",db(pb,"paginator")),mb.subscribe("load",cb),eb(mb,"filter"),eb(mb,"order"),eb(mb,"paginator"),pb.setPage(1),$(document).keydown(function(a){if(qb.$().is(":hover")||pb.$().is(":hover"))switch(a.keyCode){case 37:a.preventDefault(),sb.close(),pb.setPreviousPage();break;case 38:a.preventDefault(),qb.setPreviousSelected();break;case 39:a.preventDefault(),sb.close(),pb.setNextPage();break;case 40:a.preventDefault(),qb.setNextSelected();break;case 13:qb.selectedItem&&(a.preventDefault(),qb.selectedItem.publish("edit",qb.selectedItem))}}),n},formList:function(a){a=a||{};var d,g=A(),j=a.url,k=a.name,m=a.readOnly||!1,n=b(a.deletable,m),o=a.isSoftREST||!1,p=r(a.schema,c),q=f(p),s=a.validate,t=e(h,{url:j,schema:q,isSoftREST:o,validate:s}),u=a.modal||i,v=a.addItemAction||function(a,b){a.hide(),a.slideDown(300,b)},w=a.removeItemAction||function(a,b){a.slideUp(300,b)},x=a.createDeleteConfirmationTemplate||x,y=function(){return a.createFormListTemplate?a.createFormListTemplate.apply({schema:p,name:k,createInput:J,uniqueID:z,deletable:n,createDeleteConfirmationTemplate:x}):O(p,k,n)},B=function(){return a.createFormTemplate?a.createFormTemplate.apply({schema:p,name:k,createInput:J,uniqueID:z}):N(p,k)},C=function(){var a=X({el:"#"+k+"-crud-container",schema:q,modal:u,model:t(),template:B()});return a.render(),a.model.subscribe("saved",function(b){b&&(F(a.model),a.close())}),a},E=function(){d||(d=C(),d.model.subscribe("saved",function(){d=null})),d.open()},F=function(a){var b=k+"-crud-item-"+z();$("#"+k+"-crud-form-list").prepend('<div class="crud-form-list-item" id="'+b+'"></div>');var c=Y({el:"#"+b,schema:q,modal:u,model:a,template:y()});c.setEl("#"+b),c.render(),a.subscribe("destroyed",function(){w(c.$(),function(){c.$().remove()})}),v(c.$())};return $("#"+k+"-crud-new").html(a.newButtonHTML||"<button>Create New "+k+"</button>"),$("#"+k+"-crud-new").find("button").click(function(){E()}),$.ajax({method:"GET",url:j,dataType:"json",success:function(a){console.log("ajax response",a),l(a.data,function(a){var b=a.id;delete a.id,F(D({data:a,url:j,validate:s,id:b}))})},error:function(){console.error("ajax error",arguments)}}),g},forminator:function(a){a=a||{};var b=A(),d=a.url,e=a.name,h=r(a.schema,c),i=f(h),j=a.validate,k=I({url:d,data:g(a.schema),validate:j}),l=bb({el:"#"+e+"-forminator",schema:i,model:k,template:a.createForminatorTemplate?a.createForminatorTemplate.apply({schema:h,name:e,createInput:J,uniqueID:z}):T(h,e)});return k.subscribe("posted",function(){console.log("posted"),l.render(k.get(),{},{successMessage:a.successMessage||"Submit Success."}),setTimeout(function(){l.render(k.get(),{})},5e3)}),b}}}()}).call(this);