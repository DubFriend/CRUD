// crud
// https://github.com/DubFriend/CRUD.git
// 10-27-2013
(function(){"use strict";var a=function(a){return a},b=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}},c=function(a){return a instanceof Array},d=function(a){return!c(a)&&a instanceof Object},e=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},f=function(a){return JSON.parse(JSON.stringify(a))},g=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},h=function(a,b){var c,d,e,f=[];for(void 0===b?(d=0,e=a-1):(d=a,e=b),c=d;e>=c;c+=1)f.push(c);return f},i=function(a,b){var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},j=function(a,b,c){var d={};return g(a,function(a,e,f){e=c?c(e):e,d[e]=b(a,e,f)}),d},k=function(a,b,d){return c(a)?i(a,b):j(a,b,d)},l=function(a,b){var c;return g(a,function(d,e){c=b(c,d,e,a)}),c},m=function(a,b){var d;return c(a)?(d=[],g(a,function(a,c,e){b(a,c,e)&&d.push(a)})):(d={},g(a,function(a,c,e){b(a,c,e)&&(d[c]=a)})),d},n=function(){var a={};return g(arguments,function(b){g(b,function(b,c){a[c]=b})}),a},o=function(a){a=a||{};var b={};return a.publish=function(a,c){g(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){g(b,function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)})},a},p=function(a){a=a||{};var b=o(),c=a.url,d=a.data||{},h=a.id,i=a.ajax||function(a){$.ajax({url:b.isNew()?c:c+"/"+b.id(),method:a.method,data:"PUT"===a.method||"DELETE"===a.method?JSON.stringify(d):d,dataType:"json",success:a.success,error:function(a){409===a.status&&b.publish("error",a.responseJSON)}})};return b.isNew=function(){return void 0===h?!0:!1},b.id=function(){return h},b.get=function(a){return a?d[a]:f(d)},b.set=function(a){g(a,function(a,b){d[b]=a}),b.publish("change",b)},b.clear=function(){d={},h=void 0,b.publish("change",b)},b.validate=a.validate||function(){return{}},b.save=function(){var a=b.validate(b.get());e(a)&&i({url:b.isNew()?c:c+"/"+h,method:b.isNew()?"POST":"PUT",data:d,success:function(a){var c=b.isNew();h=b.isNew()?a:h,b.publish("saved",c)}}),b.publish("error",a)},b.delete=function(){console.log("delete",b.id()),b.isNew()?(b.clear(),b.publish("change",b)):i({url:c+"/"+h,method:"DELETE",success:function(a){console.log("delete success",a);var c=b.id();b.clear(),b.publish("destroyed",c)}})},b},q=function(a){a=a||{};var b=o(),c={};return c.pageNumber=a.pageNumber||1,c.numberOfPages=a.numberOfPages||1,b.validate=function(a){a=a||c;var b={},d=void 0!==a.numberOfPages?a.numberOfPages:c.numberOfPages,e=void 0!==a.pageNumber?a.pageNumber:c.pageNumber;return 0>=e?b.pageNumber="Page number must be greater than zero.":e>d&&(b.pageNumber="Page number must be less than or equal to the number of pages."),b},b.set=function(a){var d=b.validate(a);return e(d)?(c=n(c,a),b.publish("change",a),!0):(b.publish("error",d),!1)},b.get=function(a){return a?c[a]:f(c)},b},r=function(a,b){var c=function(a,c){var d=function(d,e,f){f=void 0===f?!0:f;var g=function(){return"checkbox"===a.type||"radio"===a.type?'value="'+e+'" ':'value="{{'+c+'}}" '},h=function(){return"checkbox"===a.type||"radio"===a.type?'id="'+c+"-"+e+'" ':'id="'+b+"-"+c+'" '};return""+(f?'<div class="input">':"")+'<input type="'+a.type+'" '+h()+'name="'+c+'" '+g()+(d?"checked":"")+"/>"+(f?"</div>":"")},e=function(){return'<div class="input">'+l(a.values,function(a,b){return(a||"")+'<label for="'+c+"-"+b+'">'+b+"</label>"+"{{#"+c+"."+b+"}}"+d(!0,b,!1)+"{{/"+c+"."+b+"}}"+"{{^"+c+"."+b+"}}"+d(!1,b,!1)+"{{/"+c+"."+b+"}}"})+"</div>"};switch(a.type){case"text":return d();case"password":return d();case"textarea":return'<div class="input"><textarea id="'+b+"-"+c+'" '+'name="'+c+'">'+"{{"+c+"}}"+"</textarea>"+"</div>";case"checkbox":return e();case"radio":return e();case"select":return'<div class="input"><select name="'+c+'">'+l(a.values,function(a,b){return a=a||"",a+"{{#"+c+"."+b+"}}"+'<option value="'+b+'" selected>'+b+"</option>"+"{{/"+c+"."+b+"}}"+"{{^"+c+"."+b+"}}"+'<option value="'+b+'">'+b+"</option>"+"{{/"+c+"."+b+"}}"})+"</select>"+"</div>";default:throw"Invalid input type: "+a.type}};return"<form><fieldset><legend>"+b+"</legend>"+l(a,function(a,d,e){return(a||"")+'<div class="control-set">'+'<label for="'+b+"-"+e+'" class="label">'+e+"</label>"+c(d,e)+'<div class="crud-help">{{'+e+"Help}}</div>"+"</div>"})+'<div class="control-set">'+'<div class="label">&nbsp;</div>'+'<div class="input">'+'<input type="submit" class="js-crud-save" value="Save"/>'+'<button id="crud-new-item" type="button">New '+b+"</button>"+"</div>"+"</div>"+"</fieldset>"+"</form>"},s=function(a){return'<table><thead><tr><th><label for="crud-list-select-all">All</label><input type="checkbox" id="crud-list-select-all"/></th>'+l(a,function(a,b,c){return(a||"")+"<th>"+c+"</th>"})+"</tr>"+"</thead>"+'<tbody id="crud-list-item-container"></tbody>'+"</table>"+'<button id="crud-delete-selected">Delete Selected</button>'},t=function(){return'<ol class="crud-pages">{{#pages}}<li>{{.}}</li>{{/pages}}</ol>'},u=function(a){return'<td><input type="checkbox" class="crud-list-selected"/></td>'+l(a,function(a,b,c){return(a||"")+'<td class="crud-list-item-column" name="'+c+'">{{'+c+"}}</td>"})},v=function(c){var d={},e=c.el,f=function(a,b,c){b=b||d.model.get(),c=a?d.mapErrorData(n(d.model.validate(b),c)):{},d.$().html(Mustache.render(d.template,n(d.mapModelToView(b),c)))};return d.mapErrorData=function(b){return k(b,a,function(a){return a+"Help"})},d.schema=c.schema,d.model=c.model,d.template=c.template,d.$=function(a){return a?$(e).find(a):$(e)},d.mapModelToView=function(a){var b=function(a,b,c){var e=d.schema[c].type;return"radio"===e||"select"===e?a===b:-1!==b.indexOf(a)};return k(a,function(a,c){var e=d.schema[c].type;if("checkbox"===e||"select"===e||"radio"===e){var f={};return g(d.schema[c].values,function(d){b(d,a,c)&&(f[d]=!0)}),f}return a})},d.render=b(f,!0),d.renderNoError=b(f,!1),d},w=function(a){a=a||{},a.el=a.el||"#crud-list-item-"+a.model.id();var b=o(v(a));b.isSelected=function(){return b.$(".crud-list-selected").prop("checked")?!0:!1};var c=b.mapModelToView;b.mapModelToView=function(a){return k(c(a),function(a){return d(a)?i(a,function(a,b){return b}).join(", "):a})};var e=b.render;return b.render=function(a){e(a),b.bindView()},b.select=function(){b.$().addClass("selected")},b.deselect=function(){b.$().removeClass("selected")},b.bindView=function(){b.$(".crud-list-item-column").hover(function(){b.$().addClass("hover")},function(){b.$().removeClass("hover")}),b.$(".crud-list-item-column").click(function(){b.publish("selected",b)})},b.model.subscribe("saved",function(){b.render()}),b},x=function(a){a=a||{};var b=v(a);return b.render=function(a){var c=b.model.validate();alert("render paginator"),console.log(b.template),b.$().html(Mustache.render(b.template,{pages:h(1,a),error:c}))},b},y=function(a){a=a||{};var b=o(v(a)),c=[],d=function(){var a=b.$("#crud-list-item-container");a.html(""),g(c,function(b){console.log(b.model.id());var c="crud-list-item-"+b.model.id();a.append('<tr id="'+c+'" '+'class="list-item"></tr>'),b.render()}),e()},e=function(){b.$("#crud-list-select-all").unbind(),b.$("#crud-list-select-all").change(function(){b.$(".crud-list-selected").prop("checked",$(this).is(":checked"))}),b.$("#crud-delete-selected").unbind(),b.$("#crud-delete-selected").click(function(a){a.preventDefault(),g(c,function(a){a.isSelected()&&a.model.delete()})}),b.$(".crud-list-selected").unbind(),b.$(".crud-list-selected").change(function(){$("#crud-list-select-all").prop("checked",!1)})};return b.setSelected=function(a){g(c,function(a){a.deselect()}),a&&a.select()},b.setSelectAll=function(a){$("#crud-list-select-all").prop("checked",a)},b.add=function(a){c.push(a),d()},b.getItemControllerByID=function(a){return m(c,function(b){return b.model.id()===a})[0]},b.remove=function(a){c=m(c,function(b){return b.model.id()!=a}),d()},b},z=function(a){a=a||{},a.model=a.model||a.createDefaultModel();var b=o(v(a));b.serialize=function(){return k(b.schema,function(a,c){var d=function(a){return b.$('[name="'+c+'"]'+(a||"")).val()};switch(a.type){case"radio":return d(":checked");case"select":return d(" option:selected");case"checkbox":var e=[];return b.$('[name="'+c+'"]:checked').each(function(){e.push($(this).val())}),e;default:return d()}})};var c=function(){b.$().unbind(),b.$().submit(function(a){a.preventDefault(),b.model.set(b.serialize()),b.model.save()}),$("#crud-new-item").unbind(),$("#crud-new-item").click(function(){b.setModel(a.createDefaultModel()),b.publish("new")})};c();var d=function(){var a=b.$("#crud-new-item");b.model.isNew()&&!a.is(":hidden")?a.hide():!b.model.isNew()&&a.is(":hidden")&&a.show()},e=b.render;b.render=function(a,b){e(a,b),d(),c()};var f=b.renderNoError;return b.renderNoError=function(a){f(a),b.$("#crud-new-item").hide(),d(),c()},b.setModel=function(){var a=d,c=function(){b.render()},e=function(a){b.render(b.model.get(),a)};return function(d){b.model.unsubscribe(c),b.model.unsubscribe(a),b.model.unsubscribe(e),d.subscribe("change",c),d.subscribe("saved",a),d.subscribe("error",e),b.model=d,d.isNew()?b.renderNoError():b.render()}}(),b.setModel(b.model),b};this.createCRUD=function(a){a=a||{};var b={},c=a.url,d=a.name,e=k(a.schema,function(a){return"checkbox"===a.type&&(a.value=a.value||[]),a}),f=a.validate,h=function(a,b){return p({id:b,url:c,data:a||k(e,function(a){return a.value||null}),validate:f})};b.listTemplate=a.listTemplate||s(e,d),b.listItemTemplate=a.listItemTemplate||u(e,d),b.formTemplate=a.formTemplate||r(e,d),b.paginatorTemplate=a.paginatorTemplate||t();var i=x({el:"#"+d+"-crud-paginator-nav",model:q(),template:b.paginatorTemplate});i.render(3);var j=y({el:"#"+d+"-crud-list-container",schema:e,model:h(),createModel:h,template:b.listTemplate});j.renderNoError();var l=function(a){return a.subscribe("saved",function(b){b&&v(a)}),a.subscribe("destroyed",function(a){console.log("destroyed",a),j.remove(a),j.setSelectAll(!1)}),a},m=z({el:"#"+d+"-crud-container",schema:e,createDefaultModel:function(){return l(h())},template:b.formTemplate});m.subscribe("new",function(){j.setSelected()});var n=function(a){m.setModel(a)},o=function(a){j.setSelected(a),n(a.model)},v=function(a){var c=w({model:a,schema:e,template:b.listItemTemplate});c.subscribe("selected",o),j.add(c),j.setSelected(c),l(a)};return b.newItem=function(){var a=h();n(a),l(a)},b.init=function(){b.newItem(),$.ajax({url:c,method:"GET",dataType:"json",success:function(a){g(a.data,function(a){var b=a.id;delete a.id,v(h(a,b))}),j.setSelected()}})},b}}).call(this);